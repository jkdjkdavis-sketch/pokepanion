<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokémon Utility App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* CSS Variables for theming. These will be updated by JavaScript. */
        :root {
            --color-bg-primary: #f3f4f6;
            --color-text-primary: #111827;
            --color-bg-card: #ffffff;
            --color-text-secondary: #6b7280;
            --color-accent: #4f46e5;
            --color-accent-hover: #4338ca;
            --color-border: #e5e7eb;
        }

        .dark {
            --color-bg-primary: #111827;
            --color-text-primary: #f9fafb;
            --color-bg-card: #1f2937;
            --color-text-secondary: #9ca3af;
            --color-accent: #6366f1;
            --color-accent-hover: #4f46e5;
            --color-border: #374151;
        }

        .type-badge {
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: capitalize;
            display: inline-block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        /* Styles for active and inactive tabs using CSS variables */
        .tab-active {
            border-color: var(--color-accent);
            color: var(--color-accent);
        }
        .tab-inactive {
            border-color: transparent;
            color: var(--color-text-secondary);
        }
        .tab-inactive:hover {
            border-color: var(--color-border);
            color: var(--color-text-primary);
        }
        .custom-checkbox, .custom-select, .custom-input {
            accent-color: var(--color-accent);
            background-color: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: 0.5rem;
            color: var(--color-text-primary);
        }
        .custom-input:focus, .custom-select:focus {
             outline: 2px solid var(--color-accent);
             outline-offset: 2px;
        }
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details > summary::before {
            content: '▶';
            margin-right: 0.5rem;
            font-size: 0.8em;
            display: inline-block;
            transition: transform 0.2s;
        }
        details[open] > summary::before {
            transform: rotate(90deg);
        }
        .shiny-active {
            color: #f59e0b; /* amber-500 */
            fill: #f59e0b;
        }
    </style>
</head>
<body class="bg-[var(--color-bg-primary)] text-[var(--color-text-primary)] min-h-screen p-4">

    <!-- Dark Mode Toggle Button -->
    <button id="themeToggle" class="fixed top-4 left-4 z-50 p-2 rounded-full bg-[var(--color-bg-card)] shadow-md text-[var(--color-text-primary)]">
        <svg id="themeIconSun" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
        <svg id="themeIconMoon" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
    </button>

    <div class="w-full max-w-7xl mx-auto pt-12">
        <h1 class="text-4xl font-bold text-center mb-6">Pokémon Finder</h1>

        <!-- Predictive Search Input & Random Button -->
        <div class="mb-6 max-w-2xl mx-auto flex gap-2 relative">
            <div class="w-full relative">
                <input type="text" id="pokemonSearchInput" class="w-full p-4 rounded-lg shadow-md border-0 focus:ring-2 focus:ring-[var(--color-accent)] bg-[var(--color-bg-card)]" placeholder="Search for a Pokémon..." autocomplete="off" disabled>
                <div id="searchResults" class="absolute top-full left-0 right-0 mt-1 bg-[var(--color-bg-card)] rounded-lg shadow-lg max-h-60 overflow-y-auto z-10 hidden"></div>
            </div>
            <button id="randomBtn" class="bg-[var(--color-accent)] hover:bg-[var(--color-accent-hover)] text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors flex-shrink-0">
                Random
            </button>
        </div>

        <!-- Main Content Area -->
        <div class="flex flex-col lg:flex-row gap-6 justify-center items-start">

            <!-- Left Column: Type Effectiveness -->
            <div id="typeEffectivenessPanel" class="bg-[var(--color-bg-card)] rounded-xl shadow-lg p-6 w-full lg:w-1/4 hidden fade-in">
                 <div id="typeLoader" class="text-center hidden">
                     <p class="text-sm text-[var(--color-text-secondary)]">Calculating...</p>
                 </div>
                 <div id="typeContent" class="hidden">
                     <div class="mb-6">
                         <h3 class="text-xl font-semibold mb-3 text-center">Strong Against</h3>
                         <div id="advantagesList" class="flex flex-wrap gap-2 justify-center"></div>
                     </div>
                     <div>
                         <h3 class="text-xl font-semibold mb-3 text-center">Weak Against</h3>
                         <div id="disadvantagesList" class="flex flex-wrap gap-2 justify-center"></div>
                     </div>
                 </div>
                 <!-- Pokedex Entry -->
                 <div id="pokedexEntryPanel" class="mt-6 border-t border-[var(--color-border)] pt-4">
                     <h3 class="text-xl font-semibold mb-3 text-center">Pokédex Entry</h3>
                     <div id="pokedexEntryLoader" class="text-center hidden">
                         <p class="text-sm text-[var(--color-text-secondary)]">Loading...</p>
                     </div>
                     <p id="pokemonGeneration" class="text-sm font-medium text-[var(--color-text-primary)] text-center mb-2"></p>
                     <p id="pokedexEntry" class="text-sm text-[var(--color-text-secondary)] text-center"></p>
                 </div>
            </div>

            <!-- Center Column: Pokémon Display Card -->
            <div id="pokemonCard" class="bg-[var(--color-bg-card)] rounded-xl shadow-lg p-6 w-full lg:w-2/4 hidden fade-in">
                <div id="loader" class="text-center hidden">
                    <svg class="animate-spin h-10 w-10 text-[var(--color-accent)] mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p class="mt-2">Fetching Pokémon...</p>
                </div>
                <div id="errorMessage" class="text-center hidden">
                     <p class="text-red-500 font-semibold">Uh oh! Pokémon not found.</p>
                </div>
                <div id="pokemonContent" class="hidden">
                    <div class="flex flex-col md:flex-row gap-6 items-center md:items-start">
                        <div class="flex flex-col items-center flex-shrink-0 w-full md:w-1/2">
                            <div class="w-48 h-48 mb-4 bg-black/5 dark:bg-black/20 rounded-full flex items-center justify-center"><img id="pokemonImage" src="" alt="Pokémon Image" class="w-full h-full object-contain"></div>
                            <div class="flex items-center gap-2">
                                <h2 id="pokemonName" class="text-3xl font-bold capitalize"></h2>
                                <button id="shinyToggleBtn" class="p-1 rounded-full text-[var(--color-text-secondary)] hover:text-yellow-400 hover:bg-yellow-400/20 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                                </button>
                            </div>
                            <p id="pokemonId" class="text-[var(--color-text-secondary)]"></p>
                            <div id="pokemonTypes" class="flex gap-2 mt-2"></div>
                            <div id="formSelectorContainer" class="mt-4 w-full hidden">
                                <label for="formSelector" class="block text-sm font-medium mb-1 text-center">Alternate Forms</label>
                                <select id="formSelector" class="custom-select w-full p-2"></select>
                            </div>
                            <button id="sendToCalculatorBtn" class="mt-4 w-full bg-[var(--color-accent)] hover:bg-[var(--color-accent-hover)] text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">
                                Send Stats to Calculator
                            </button>
                        </div>
                        <div class="w-full md:w-1/2">
                            <h3 class="text-xl font-semibold text-center md:text-left mb-4">Base Stats</h3>
                            <div id="pokemonStats" class="space-y-3"></div>
                             <div class="mt-4 pt-4 border-t border-[var(--color-border)]">
                                 <h3 class="text-xl font-semibold text-center md:text-left mb-2">Common Roles</h3>
                                 <div id="rolesLoader" class="text-center hidden">
                                     <p class="text-sm text-[var(--color-text-secondary)]">Analyzing roles...</p>
                                 </div>
                                 <p id="pokemonRoles" class="text-sm text-[var(--color-text-secondary)]"></p>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Matchups -->
            <div id="matchupsPanel" class="bg-[var(--color-bg-card)] rounded-xl shadow-lg p-6 w-full lg:w-1/4 hidden fade-in">
                <div id="matchupLoader" class="text-center hidden">
                    <p class="text-sm text-[var(--color-text-secondary)]">Finding Matchups...</p>
                </div>
                <div id="matchupContent" class="hidden">
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-3 text-center">Bad Matchups</h3>
                        <div id="badMatchupsList" class="grid grid-cols-3 gap-2 text-center"></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-center">Good Matchups</h3>
                        <div id="goodMatchupsList" class="grid grid-cols-3 gap-2 text-center"></div>
                    </div>
                    <div class="mt-4 text-center">
                        <button id="regenerateMatchupsBtn" class="bg-[var(--color-accent)] hover:bg-[var(--color-accent-hover)] text-white font-bold py-2 px-4 rounded-lg transition-colors w-full">
                            New Matchups
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Evolution Line Button -->
        <div class="mt-8 w-full max-w-2xl mx-auto">
            <button id="showEvolutionBtn" class="w-full bg-[var(--color-bg-card)] hover:bg-gray-200 dark:hover:bg-gray-700 text-[var(--color-text-primary)] font-bold py-3 px-4 rounded-lg shadow-lg transition-colors">
                Show Evolution Line
            </button>
        </div>

        <!-- New Tabs Section -->
        <div class="mt-8 w-full bg-[var(--color-bg-card)] rounded-xl shadow-lg p-6">
            <div class="border-b border-[var(--color-border)]">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="aiTab" type="button" class="tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">AI Generator</button>
                    <button id="manualTab" type="button" class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Manual Builder</button>
                    <button id="movesTab" type="button" class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Moves/Abilities</button>
                    <button id="teamBuilderTab" type="button" class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Team Builder</button>
                    <button id="teamGeneratorTab" type="button" class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Team Generator</button>
                    <button id="teamFillerTab" type="button" class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Team Filler</button>
                    <button id="statCalculatorTab" type="button" class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Stat Calculator</button>
                </nav>
            </div>
            <div class="mt-4">
                <div id="aiPanel">
                     <div class="text-center mb-4">
                         <button id="generateBuildBtn" class="bg-[var(--color-accent)] hover:bg-[var(--color-accent-hover)] text-white font-bold py-2 px-6 rounded-lg transition-colors">
                             Generate Builds
                         </button>
                     </div>
                     <div class="flex justify-center items-center gap-4 mb-4">
                          <div class="flex items-center gap-2">
                              <input type="checkbox" id="anyAbilityCheckbox" class="custom-checkbox h-4 w-4 rounded">
                              <label for="anyAbilityCheckbox" class="text-sm">Use any ability</label>
                          </div>
                          <div>
                              <select id="roleSelector" class="custom-select p-2 rounded-lg bg-[var(--color-bg-card)] border border-[var(--color-border)] focus:ring-2 focus:ring-[var(--color-accent)] text-sm">
                                  <option value="any">Any Role</option>
                                  <option value="Physical Sweeper">Physical Sweeper</option>
                                  <option value="Special Sweeper">Special Sweeper</option>
                                  <option value="Physical Wall">Physical Wall</option>
                                  <option value="Special Wall">Special Wall</option>
                                  <option value="Mixed Attacker">Mixed Attacker</option>
                                  <option value="Lead">Lead</option>
                                  <option value="Support">Support</option>
                                  <option value="Hazard Setter">Hazard Setter</option>
                              </select>
                          </div>
                     </div>
                     <div id="aiBuildDisplay" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                         <p class="text-[var(--color-text-secondary)] text-center md:col-span-2 lg:col-span-3">Generated builds for the selected Pokémon will appear here...</p>
                     </div>
                </div>
                <div id="manualPanel" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-8 gap-y-6">
                        <!-- Top Row -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Core Details -->
                            <div class="space-y-4">
                                <div>
                                    <label for="levelInput" class="block text-sm font-medium mb-1">Level</label>
                                    <input type="number" id="levelInput" min="1" max="100" value="100" class="custom-input w-full p-2">
                                </div>
                                <div>
                                    <label for="abilitySelector" class="block text-sm font-medium mb-1">Ability</label>
                                    <select id="abilitySelector" class="custom-select w-full p-2"></select>
                                    <div class="flex items-center gap-2 mt-2">
                                        <input type="checkbox" id="manualAnyAbilityCheckbox" class="custom-checkbox h-4 w-4 rounded">
                                        <label for="manualAnyAbilityCheckbox" class="text-sm">Use any ability</label>
                                    </div>
                                </div>
                                <div>
                                    <label for="natureSelector" class="block text-sm font-medium mb-1">Nature</label>
                                    <select id="natureSelector" class="custom-select w-full p-2"></select>
                                </div>
                                <div>
                                    <label for="itemSelector" class="block text-sm font-medium mb-1">Item</label>
                                    <select id="itemSelector" class="custom-select w-full p-2"></select>
                                </div>
                                 <div>
                                    <label for="teraTypeSelector" class="block text-sm font-medium mb-1">Tera Type</label>
                                    <select id="teraTypeSelector" class="custom-select w-full p-2"></select>
                                </div>
                            </div>
                            <!-- Moves -->
                            <div class="space-y-4">
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" id="manualAnyMoveCheckbox" class="custom-checkbox h-4 w-4 rounded">
                                    <label for="manualAnyMoveCheckbox" class="text-sm">Use any move</label>
                                </div>
                                <div>
                                    <label for="moveSelector1" class="block text-sm font-medium mb-1">Move 1</label>
                                    <select id="moveSelector1" class="custom-select w-full p-2 move-selector"></select>
                                </div>
                                 <div>
                                    <label for="moveSelector2" class="block text-sm font-medium mb-1">Move 2</label>
                                    <select id="moveSelector2" class="custom-select w-full p-2 move-selector"></select>
                                </div>
                                 <div>
                                    <label for="moveSelector3" class="block text-sm font-medium mb-1">Move 3</label>
                                    <select id="moveSelector3" class="custom-select w-full p-2 move-selector"></select>
                                </div>
                                 <div>
                                    <label for="moveSelector4" class="block text-sm font-medium mb-1">Move 4</label>
                                    <select id="moveSelector4" class="custom-select w-full p-2 move-selector"></select>
                                </div>
                            </div>
                        </div>
                        <!-- Bottom Row -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- EVs & IVs -->
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <h4 class="text-sm font-medium">Effort Values (EVs)</h4>
                                        <p class="text-sm">Remaining: <span id="evRemaining">510</span></p>
                                    </div>
                                    <div id="evInputs" class="space-y-2 text-xs"></div>
                                </div>
                                 <div>
                                    <h4 class="text-sm font-medium mb-1">Individual Values (IVs)</h4>
                                    <div id="ivInputs" class="space-y-2 text-xs"></div>
                                </div>
                            </div>
                            <!-- Calculated Stats -->
                            <div class="space-y-2">
                                <h3 class="text-xl font-semibold text-center mb-2">Calculated Stats</h3>
                                <div id="calculatedStatsDisplay" class="p-4 border border-[var(--color-border)] rounded-lg space-y-2">
                                    <!-- Stats will be populated here -->
                                </div>
                                <button id="copyManualBuildBtn" class="mt-4 w-full bg-[var(--color-accent)] hover:bg-[var(--color-accent-hover)] text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">
                                    Copy for Showdown/PKHeX
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="movesPanel" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Abilities Section -->
                        <div>
                            <h3 class="text-xl font-semibold mb-3">Abilities</h3>
                            <div class="space-y-2">
                                <select id="movesTabAbilitySelector" class="custom-select w-full p-2"></select>
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" id="movesTabAnyAbilityCheckbox" class="custom-checkbox h-4 w-4 rounded">
                                    <label for="movesTabAnyAbilityCheckbox" class="text-sm">Show all abilities</label>
                                </div>
                                <div id="movesTabAbilityDescription" class="mt-2 p-3 border border-[var(--color-border)] rounded-lg text-sm min-h-[100px] bg-black/5 dark:bg-black/20">
                                    <p class="text-[var(--color-text-secondary)]">Select an ability to see its description.</p>
                                </div>
                            </div>
                        </div>
                         <!-- Items Section -->
                        <div>
                            <h3 class="text-xl font-semibold mb-3">Items</h3>
                            <div class="space-y-2">
                                <select id="movesTabItemSelector" class="custom-select w-full p-2"></select>
                                <div id="movesTabItemDescription" class="mt-2 p-3 border border-[var(--color-border)] rounded-lg text-sm min-h-[100px] bg-black/5 dark:bg-black/20">
                                    <p class="text-[var(--color-text-secondary)]">Select an item to see its description.</p>
                                </div>
                            </div>
                        </div>
                        <!-- Natures Section -->
                        <div>
                            <h3 class="text-xl font-semibold mb-3">Natures</h3>
                            <div class="space-y-2">
                                <select id="movesTabNatureSelector" class="custom-select w-full p-2"></select>
                                <div id="movesTabNatureDescription" class="mt-2 p-3 border border-[var(--color-border)] rounded-lg text-sm min-h-[100px] bg-black/5 dark:bg-black/20">
                                    <p class="text-[var(--color-text-secondary)]">Select a nature to see its effect.</p>
                                </div>
                            </div>
                        </div>
                        <!-- Moves Section -->
                        <div>
                            <h3 class="text-xl font-semibold mb-3">Moves</h3>
                            <div class="flex items-center gap-2 mb-2">
                                <input type="checkbox" id="movesTabAnyMoveCheckbox" class="custom-checkbox h-4 w-4 rounded">
                                <label for="movesTabAnyMoveCheckbox" class="text-sm">Show all moves</label>
                            </div>
                             <div id="movesTabMovesList" class="max-h-60 overflow-y-auto space-y-1 pr-2 border border-[var(--color-border)] rounded-lg p-2 bg-black/5 dark:bg-black/20">
                                 <!-- Moves will be populated here -->
                             </div>
                             <div id="movesTabMoveDescription" class="mt-2 p-3 border border-[var(--color-border)] rounded-lg text-sm min-h-[100px] bg-black/5 dark:bg-black/20">
                                 <p class="text-[var(--color-text-secondary)]">Select a move to see its details.</p>
                             </div>
                        </div>
                    </div>
                </div>
                <div id="teamBuilderPanel" class="hidden">
                    <div class="flex flex-col items-center">
                        <div class="w-full max-w-lg mb-4 text-center">
                            <label for="teamBuilderSearchInput" class="block text-sm font-medium mb-1">Search for Pokémon to add to the pool (up to 12):</label>
                            <div class="relative">
                                <input type="text" id="teamBuilderSearchInput" class="custom-input w-full p-2" placeholder="e.g., Pikachu">
                                <div id="teamBuilderSearchResults" class="absolute top-full left-0 right-0 mt-1 bg-[var(--color-bg-card)] rounded-lg shadow-lg max-h-60 overflow-y-auto z-10 hidden"></div>
                            </div>
                        </div>
                        <div id="selectionPool" class="w-full max-w-4xl min-h-[100px] bg-black/5 dark:bg-black/20 rounded-lg p-4 mb-4 grid grid-cols-4 md:grid-cols-6 lg:grid-cols-12 gap-2 items-center justify-center">
                             <p id="selectionPoolPlaceholder" class="text-[var(--color-text-secondary)] text-center col-span-full">Selected Pokémon will appear here...</p>
                        </div>
                        <button id="allocateTeamsBtn" class="bg-[var(--color-accent)] hover:bg-[var(--color-accent-hover)] text-white font-bold py-2 px-6 rounded-lg transition-colors mb-4">
                            Allocate Teams
                        </button>
                        <div id="teamBuilderResults" class="w-full grid grid-cols-1 md:grid-cols-3 gap-4">
                           <!-- Allocated teams will be displayed here -->
                        </div>
                    </div>
                </div>
                <div id="teamGeneratorPanel" class="hidden">
                    <div class="flex flex-col items-center">
                        <div class="flex items-center gap-4 mb-4">
                            <label for="teamGenRoleSelector" class="text-sm font-medium">Role for Current Pokémon:</label>
                            <select id="teamGenRoleSelector" class="custom-select p-2 rounded-lg bg-[var(--color-bg-card)] border border-[var(--color-border)] focus:ring-2 focus:ring-[var(--color-accent)] text-sm">
                                <option value="any">Any Role</option>
                                <option value="Physical Sweeper">Physical Sweeper</option>
                                <option value="Special Sweeper">Special Sweeper</option>
                                <option value="Physical Wall">Physical Wall</option>
                                <option value="Special Wall">Special Wall</option>
                                <option value="Mixed Attacker">Mixed Attacker</option>
                                <option value="Lead">Lead</option>
                                <option value="Support">Support</option>
                                <option value="Hazard Setter">Hazard Setter</option>
                            </select>
                        </div>
                        <button id="generateTeamBtn" class="bg-[var(--color-accent)] hover:bg-[var(--color-accent-hover)] text-white font-bold py-2 px-6 rounded-lg transition-colors mb-4">
                            Generate Team
                        </button>
                        <div id="teamGeneratorDisplay" class="w-full grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                            <p class="text-[var(--color-text-secondary)] text-center col-span-full">Generated team will appear here...</p>
                        </div>
                    </div>
                </div>
                <div id="teamFillerPanel" class="hidden">
                     <div class="flex flex-col items-center">
                        <div class="w-full max-w-lg mb-4">
                             <label for="teamFillerInput" class="block text-sm font-medium mb-1 text-center">Enter 1-5 Pokémon you already have on your team (comma-separated):</label>
                             <input type="text" id="teamFillerInput" class="custom-input w-full p-2" placeholder="e.g., Garchomp, Toxapex, Corviknight">
                        </div>
                        <button id="fillTeamBtn" class="bg-[var(--color-accent)] hover:bg-[var(--color-accent-hover)] text-white font-bold py-2 px-6 rounded-lg transition-colors mb-4">
                            Fill My Team
                        </button>
                        <div id="teamFillerDisplay" class="w-full grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                            <p class="text-[var(--color-text-secondary)] text-center col-span-full">AI-suggested teammates will appear here...</p>
                        </div>
                    </div>
                </div>
                <div id="statCalculatorPanel" class="hidden">
                    <!-- Content generated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Evolution Modal -->
    <div id="evolutionModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-[var(--color-bg-card)] rounded-xl shadow-lg p-6 w-full max-w-3xl relative">
            <button id="closeEvolutionModalBtn" class="absolute top-2 right-2 text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)]">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h3 class="text-2xl font-bold text-center mb-4">Evolution Line</h3>
            <div id="evolutionChainDisplay" class="flex items-center justify-center gap-2 flex-wrap">
                <!-- Evolution chain will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const allDOMElements = {
            themeToggle: document.getElementById('themeToggle'),
            themeIconSun: document.getElementById('themeIconSun'),
            themeIconMoon: document.getElementById('themeIconMoon'),
            pokemonSearchInput: document.getElementById('pokemonSearchInput'),
            searchResults: document.getElementById('searchResults'),
            randomBtn: document.getElementById('randomBtn'),
            pokemonCard: document.getElementById('pokemonCard'),
            loader: document.getElementById('loader'),
            errorMessage: document.getElementById('errorMessage'),
            pokemonContent: document.getElementById('pokemonContent'),
            pokemonImage: document.getElementById('pokemonImage'),
            pokemonName: document.getElementById('pokemonName'),
            pokemonId: document.getElementById('pokemonId'),
            pokemonTypes: document.getElementById('pokemonTypes'),
            pokemonStats: document.getElementById('pokemonStats'),
            shinyToggleBtn: document.getElementById('shinyToggleBtn'),
            typeEffectivenessPanel: document.getElementById('typeEffectivenessPanel'),
            advantagesList: document.getElementById('advantagesList'),
            disadvantagesList: document.getElementById('disadvantagesList'),
            typeLoader: document.getElementById('typeLoader'),
            typeContent: document.getElementById('typeContent'),
            matchupsPanel: document.getElementById('matchupsPanel'),
            matchupLoader: document.getElementById('matchupLoader'),
            matchupContent: document.getElementById('matchupContent'),
            goodMatchupsList: document.getElementById('goodMatchupsList'),
            badMatchupsList: document.getElementById('badMatchupsList'),
            regenerateMatchupsBtn: document.getElementById('regenerateMatchupsBtn'),
            aiTab: document.getElementById('aiTab'),
            manualTab: document.getElementById('manualTab'),
            movesTab: document.getElementById('movesTab'),
            teamBuilderTab: document.getElementById('teamBuilderTab'),
            teamGeneratorTab: document.getElementById('teamGeneratorTab'),
            teamFillerTab: document.getElementById('teamFillerTab'),
            statCalculatorTab: document.getElementById('statCalculatorTab'),
            aiPanel: document.getElementById('aiPanel'),
            manualPanel: document.getElementById('manualPanel'),
            movesPanel: document.getElementById('movesPanel'),
            teamBuilderPanel: document.getElementById('teamBuilderPanel'),
            teamGeneratorPanel: document.getElementById('teamGeneratorPanel'),
            teamFillerPanel: document.getElementById('teamFillerPanel'),
            statCalculatorPanel: document.getElementById('statCalculatorPanel'),
            generateBuildBtn: document.getElementById('generateBuildBtn'),
            anyAbilityCheckbox: document.getElementById('anyAbilityCheckbox'),
            roleSelector: document.getElementById('roleSelector'),
            aiBuildDisplay: document.getElementById('aiBuildDisplay'),
            levelInput: document.getElementById('levelInput'),
            abilitySelector: document.getElementById('abilitySelector'),
            manualAnyAbilityCheckbox: document.getElementById('manualAnyAbilityCheckbox'),
            manualAnyMoveCheckbox: document.getElementById('manualAnyMoveCheckbox'),
            natureSelector: document.getElementById('natureSelector'),
            itemSelector: document.getElementById('itemSelector'),
            teraTypeSelector: document.getElementById('teraTypeSelector'),
            moveSelectors: document.querySelectorAll('.move-selector'),
            evInputsContainer: document.getElementById('evInputs'),
            ivInputsContainer: document.getElementById('ivInputs'),
            evRemaining: document.getElementById('evRemaining'),
            calculatedStatsDisplay: document.getElementById('calculatedStatsDisplay'),
            copyManualBuildBtn: document.getElementById('copyManualBuildBtn'),
            movesTabAbilitySelector: document.getElementById('movesTabAbilitySelector'),
            movesTabAnyAbilityCheckbox: document.getElementById('movesTabAnyAbilityCheckbox'),
            movesTabAbilityDescription: document.getElementById('movesTabAbilityDescription'),
            movesTabItemSelector: document.getElementById('movesTabItemSelector'),
            movesTabItemDescription: document.getElementById('movesTabItemDescription'),
            movesTabNatureSelector: document.getElementById('movesTabNatureSelector'),
            movesTabNatureDescription: document.getElementById('movesTabNatureDescription'),
            movesTabMovesList: document.getElementById('movesTabMovesList'),
            movesTabMoveDescription: document.getElementById('movesTabMoveDescription'),
            movesTabAnyMoveCheckbox: document.getElementById('movesTabAnyMoveCheckbox'),
            pokedexEntryPanel: document.getElementById('pokedexEntryPanel'),
            pokedexEntryLoader: document.getElementById('pokedexEntryLoader'),
            pokedexEntry: document.getElementById('pokedexEntry'),
            pokemonGeneration: document.getElementById('pokemonGeneration'),
            rolesLoader: document.getElementById('rolesLoader'),
            pokemonRoles: document.getElementById('pokemonRoles'),
            teamGenRoleSelector: document.getElementById('teamGenRoleSelector'),
            generateTeamBtn: document.getElementById('generateTeamBtn'),
            teamGeneratorDisplay: document.getElementById('teamGeneratorDisplay'),
            teamFillerInput: document.getElementById('teamFillerInput'),
            fillTeamBtn: document.getElementById('fillTeamBtn'),
            teamFillerDisplay: document.getElementById('teamFillerDisplay'),
            teamBuilderSearchInput: document.getElementById('teamBuilderSearchInput'),
            teamBuilderSearchResults: document.getElementById('teamBuilderSearchResults'),
            selectionPool: document.getElementById('selectionPool'),
            selectionPoolPlaceholder: document.getElementById('selectionPoolPlaceholder'),
            allocateTeamsBtn: document.getElementById('allocateTeamsBtn'),
            teamBuilderResults: document.getElementById('teamBuilderResults'),
            formSelectorContainer: document.getElementById('formSelectorContainer'),
            formSelector: document.getElementById('formSelector'),
            sendToCalculatorBtn: document.getElementById('sendToCalculatorBtn'),
            showEvolutionBtn: document.getElementById('showEvolutionBtn'),
            evolutionModal: document.getElementById('evolutionModal'),
            closeEvolutionModalBtn: document.getElementById('closeEvolutionModalBtn'),
            evolutionChainDisplay: document.getElementById('evolutionChainDisplay'),
        };

        // Data & Caching
        const typeColors = { normal: 'bg-gray-400', fire: 'bg-red-500', water: 'bg-blue-500', electric: 'bg-yellow-400', grass: 'bg-green-500', ice: 'bg-cyan-300', fighting: 'bg-red-700', poison: 'bg-purple-500', ground: 'bg-yellow-600', flying: 'bg-indigo-400', psychic: 'bg-pink-500', bug: 'bg-lime-500', rock: 'bg-yellow-700', ghost: 'bg-indigo-800', dragon: 'bg-indigo-600', dark: 'bg-gray-700', steel: 'bg-gray-500', fairy: 'bg-pink-300' };
        const allTypeNames = Object.keys(typeColors);
        const statNames = { 'hp': 'HP', 'attack': 'Attack', 'defense': 'Defense', 'special-attack': 'Sp. Atk', 'special-defense': 'Sp. Def', 'speed': 'Speed' };
        const showdownStatNames = { 'hp': 'HP', 'attack': 'Atk', 'defense': 'Def', 'special-attack': 'SpA', 'special-defense': 'SpD', 'speed': 'Spe' };
        const typeDataCache = new Map();
        let pokemonList = [];
        let itemList = [];
        let allAbilitiesList = [];
        let allMovesList = [];
        let currentPokemonMoves = [];
        let currentPokemonNaturalAbilities = [];
        let currentBaseStats = {};
        let teamBuilderSelection = [];
        let currentPokemonSpeciesUrl = '';
        
        const typeColorSchemes = {
            normal: { light: { '--color-bg-primary': '#f5f5f4', '--color-text-primary': '#292524', '--color-bg-card': '#ffffff', '--color-text-secondary': '#a8a29e', '--color-accent': '#a8a29e', '--color-accent-hover': '#78716c', '--color-border': '#e7e5e4' }, dark: { '--color-bg-primary': '#292524', '--color-text-primary': '#fafaf9', '--color-bg-card': '#44403c', '--color-text-secondary': '#a8a29e', '--color-accent': '#a8a29e', '--color-accent-hover': '#d6d3d1', '--color-border': '#57534e' } },
            fire: { light: { '--color-bg-primary': '#fff7ed', '--color-text-primary': '#7c2d12', '--color-bg-card': '#ffffff', '--color-text-secondary': '#fb923c', '--color-accent': '#f97316', '--color-accent-hover': '#ea580c', '--color-border': '#fed7aa' }, dark: { '--color-bg-primary': '#7c2d12', '--color-text-primary': '#ffedd5', '--color-bg-card': '#9a3412', '--color-text-secondary': '#fdba74', '--color-accent': '#fb923c', '--color-accent-hover': '#f97316', '--color-border': '#b45309' } },
            water: { light: { '--color-bg-primary': '#eff6ff', '--color-text-primary': '#1e3a8a', '--color-bg-card': '#ffffff', '--color-text-secondary': '#60a5fa', '--color-accent': '#3b82f6', '--color-accent-hover': '#2563eb', '--color-border': '#bfdbfe' }, dark: { '--color-bg-primary': '#1e3a8a', '--color-text-primary': '#dbeafe', '--color-bg-card': '#1e40af', '--color-text-secondary': '#93c5fd', '--color-accent': '#60a5fa', '--color-accent-hover': '#3b82f6', '--color-border': '#2563eb' } },
            grass: { light: { '--color-bg-primary': '#f0fdf4', '--color-text-primary': '#14532d', '--color-bg-card': '#ffffff', '--color-text-secondary': '#4ade80', '--color-accent': '#22c55e', '--color-accent-hover': '#16a34a', '--color-border': '#bbf7d0' }, dark: { '--color-bg-primary': '#14532d', '--color-text-primary': '#dcfce7', '--color-bg-card': '#166534', '--color-text-secondary': '#86efac', '--color-accent': '#4ade80', '--color-accent-hover': '#22c55e', '--color-border': '#15803d' } },
            electric: { light: { '--color-bg-primary': '#fefce8', '--color-text-primary': '#854d0e', '--color-bg-card': '#ffffff', '--color-text-secondary': '#facc15', '--color-accent': '#eab308', '--color-accent-hover': '#ca8a04', '--color-border': '#fde047' }, dark: { '--color-bg-primary': '#854d0e', '--color-text-primary': '#fef9c3', '--color-bg-card': '#a16207', '--color-text-secondary': '#fde047', '--color-accent': '#facc15', '--color-accent-hover': '#eab308', '--color-border': '#b45309' } },
            ice: { light: { '--color-bg-primary': '#ecfeff', '--color-text-primary': '#0e7490', '--color-bg-card': '#ffffff', '--color-text-secondary': '#67e8f9', '--color-accent': '#22d3ee', '--color-accent-hover': '#06b6d4', '--color-border': '#a5f3fc' }, dark: { '--color-bg-primary': '#164e63', '--color-text-primary': '#cffafe', '--color-bg-card': '#155e75', '--color-text-secondary': '#67e8f9', '--color-accent': '#22d3ee', '--color-accent-hover': '#06b6d4', '--color-border': '#0e7490' } },
            fighting: { light: { '--color-bg-primary': '#fef2f2', '--color-text-primary': '#991b1b', '--color-bg-card': '#ffffff', '--color-text-secondary': '#ef4444', '--color-accent': '#dc2626', '--color-accent-hover': '#b91c1c', '--color-border': '#fecaca' }, dark: { '--color-bg-primary': '#7f1d1d', '--color-text-primary': '#fee2e2', '--color-bg-card': '#991b1b', '--color-text-secondary': '#fca5a5', '--color-accent': '#ef4444', '--color-accent-hover': '#dc2626', '--color-border': '#b91c1c' } },
            poison: { light: { '--color-bg-primary': '#f5f3ff', '--color-text-primary': '#5b21b6', '--color-bg-card': '#ffffff', '--color-text-secondary': '#a78bfa', '--color-accent': '#8b5cf6', '--color-accent-hover': '#7c3aed', '--color-border': '#ddd6fe' }, dark: { '--color-bg-primary': '#4c1d95', '--color-text-primary': '#ede9fe', '--color-bg-card': '#5b21b6', '--color-text-secondary': '#c4b5fd', '--color-accent': '#a78bfa', '--color-accent-hover': '#8b5cf6', '--color-border': '#6d28d9' } },
            ground: { light: { '--color-bg-primary': '#fffbeb', '--color-text-primary': '#92400e', '--color-bg-card': '#ffffff', '--color-text-secondary': '#f59e0b', '--color-accent': '#d97706', '--color-accent-hover': '#b45309', '--color-border': '#fcd34d' }, dark: { '--color-bg-primary': '#78350f', '--color-text-primary': '#fef3c7', '--color-bg-card': '#92400e', '--color-text-secondary': '#fbbf24', '--color-accent': '#f59e0b', '--color-accent-hover': '#d97706', '--color-border': '#b45309' } },
            flying: { light: { '--color-bg-primary': '#e0e7ff', '--color-text-primary': '#3730a3', '--color-bg-card': '#ffffff', '--color-text-secondary': '#a5b4fc', '--color-accent': '#818cf8', '--color-accent-hover': '#6366f1', '--color-border': '#c7d2fe' }, dark: { '--color-bg-primary': '#312e81', '--color-text-primary': '#e0e7ff', '--color-bg-card': '#3730a3', '--color-text-secondary': '#a5b4fc', '--color-accent': '#818cf8', '--color-accent-hover': '#6366f1', '--color-border': '#4338ca' } },
            psychic: { light: { '--color-bg-primary': '#fdf2f8', '--color-text-primary': '#9d174d', '--color-bg-card': '#ffffff', '--color-text-secondary': '#f472b6', '--color-accent': '#ec4899', '--color-accent-hover': '#db2777', '--color-border': '#fbcfe8' }, dark: { '--color-bg-primary': '#831843', '--color-text-primary': '#fce7f3', '--color-bg-card': '#9d174d', '--color-text-secondary': '#f9a8d4', '--color-accent': '#f472b6', '--color-accent-hover': '#ec4899', '--color-border': '#be185d' } },
            bug: { light: { '--color-bg-primary': '#f7fee7', '--color-text-primary': '#365314', '--color-bg-card': '#ffffff', '--color-text-secondary': '#a3e635', '--color-accent': '#84cc16', '--color-accent-hover': '#65a30d', '--color-border': '#d9f99d' }, dark: { '--color-bg-primary': '#365314', '--color-text-primary': '#e7f5d0', '--color-bg-card': '#4d7c0f', '--color-text-secondary': '#bef264', '--color-accent': '#a3e635', '--color-accent-hover': '#84cc16', '--color-border': '#65a30d' } },
            rock: { light: { '--color-bg-primary': '#fefce8', '--color-text-primary': '#854d0e', '--color-bg-card': '#ffffff', '--color-text-secondary': '#ca8a04', '--color-accent': '#a16207', '--color-accent-hover': '#854d0e', '--color-border': '#fde047' }, dark: { '--color-bg-primary': '#713f12', '--color-text-primary': '#fef9c3', '--color-bg-card': '#854d0e', '--color-text-secondary': '#facc15', '--color-accent': '#ca8a04', '--color-accent-hover': '#a16207', '--color-border': '#b45309' } },
            ghost: { light: { '--color-bg-primary': '#f5f3ff', '--color-text-primary': '#4c1d95', '--color-bg-card': '#ffffff', '--color-text-secondary': '#8b5cf6', '--color-accent': '#7c3aed', '--color-accent-hover': '#6d28d9', '--color-border': '#ddd6fe' }, dark: { '--color-bg-primary': '#3730a3', '--color-text-primary': '#e0e7ff', '--color-bg-card': '#4338ca', '--color-text-secondary': '#a5b4fc', '--color-accent': '#818cf8', '--color-accent-hover': '#6366f1', '--color-border': '#4f46e5' } },
            dragon: { light: { '--color-bg-primary': '#eef2ff', '--color-text-primary': '#312e81', '--color-bg-card': '#ffffff', '--color-text-secondary': '#818cf8', '--color-accent': '#6366f1', '--color-accent-hover': '#4f46e5', '--color-border': '#c7d2fe' }, dark: { '--color-bg-primary': '#312e81', '--color-text-primary': '#e0e7ff', '--color-bg-card': '#3730a3', '--color-text-secondary': '#a5b4fc', '--color-accent': '#818cf8', '--color-accent-hover': '#6366f1', '--color-border': '#4338ca' } },
            dark: { light: { '--color-bg-primary': '#f1f5f9', '--color-text-primary': '#1e293b', '--color-bg-card': '#ffffff', '--color-text-secondary': '#64748b', '--color-accent': '#475569', '--color-accent-hover': '#334155', '--color-border': '#e2e8f0' }, dark: { '--color-bg-primary': '#0f172a', '--color-text-primary': '#f1f5f9', '--color-bg-card': '#1e293b', '--color-text-secondary': '#94a3b8', '--color-accent': '#64748b', '--color-accent-hover': '#94a3b8', '--color-border': '#334155' } },
            steel: { light: { '--color-bg-primary': '#f1f5f9', '--color-text-primary': '#334155', '--color-bg-card': '#ffffff', '--color-text-secondary': '#94a3b8', '--color-accent': '#64748b', '--color-accent-hover': '#475569', '--color-border': '#e2e8f0' }, dark: { '--color-bg-primary': '#1e293b', '--color-text-primary': '#f1f5f9', '--color-bg-card': '#334155', '--color-text-secondary': '#94a3b8', '--color-accent': '#94a3b8', '--color-accent-hover': '#cbd5e1', '--color-border': '#475569' } },
            fairy: { light: { '--color-bg-primary': '#fdf4ff', '--color-text-primary': '#86198f', '--color-bg-card': '#ffffff', '--color-text-secondary': '#e879f9', '--color-accent': '#d946ef', '--color-accent-hover': '#c026d3', '--color-border': '#f5d0fe' }, dark: { '--color-bg-primary': '#701a75', '--color-text-primary': '#fae8ff', '--color-bg-card': '#86198f', '--color-text-secondary': '#f0abfc', '--color-accent': '#e879f9', '--color-accent-hover': '#d946ef', '--color-border': '#a21caf' } },
        };
        const natureMultipliers = {
            lonely: { atk: 1.1, def: 0.9 }, brave: { atk: 1.1, spe: 0.9 }, adamant: { atk: 1.1, spa: 0.9 }, naughty: { atk: 1.1, spd: 0.9 },
            bold: { def: 1.1, atk: 0.9 }, relaxed: { def: 1.1, spe: 0.9 }, impish: { def: 1.1, spa: 0.9 }, lax: { def: 1.1, spd: 0.9 },
            timid: { spe: 1.1, atk: 0.9 }, hasty: { spe: 1.1, def: 0.9 }, jolly: { spe: 1.1, spa: 0.9 }, naive: { spe: 1.1, spd: 0.9 },
            modest: { spa: 1.1, atk: 0.9 }, mild: { spa: 1.1, def: 0.9 }, quiet: { spa: 1.1, spe: 0.9 }, rash: { spa: 1.1, spd: 0.9 },
            calm: { spd: 1.1, atk: 0.9 }, gentle: { spd: 1.1, def: 0.9 }, sassy: { spd: 1.1, spe: 0.9 }, careful: { spd: 1.1, spa: 0.9 }
        };

        // State
        let currentPrimaryType = 'normal';
        let currentPokemonNameForBuild = '';
        let currentTypeRelations = [];
        let currentPokemonIdForMatchup = null;
        let currentTargetBst = 0;
        let isShiny = false;
        let currentPokemonSprites = { default: '', shiny: '' };

        /**
         * A more robust helper function to call the AI proxy with exponential backoff.
         * The payload is now passed directly, allowing for different prompt and schema configurations.
         * @param {object} payload - The Gemini API payload.
         * @returns {Promise<object>} The parsed JSON response from the AI.
         */
        const callAIFunction = async (payload) => {
            
            let attempts = 0;
            const maxAttempts = 5;
            let delay = 1000;
            let lastError;

            while (attempts < maxAttempts) {
                try {
                    // Correctly calling the Netlify serverless function proxy
                    const response = await fetch('/.netlify/functions/gemini-proxy', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        const errorInfo = await response.text(); // Get raw text for better debugging
                        throw new Error(`API call failed: ${response.status}. Response body: ${errorInfo}`);
                    }

                    const responseText = await response.text();
                    
                    try {
                        const result = JSON.parse(responseText);
                        // The Gemini API returns a nested JSON string. We need to parse it.
                        const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (!jsonText) {
                             throw new Error('Unexpected API response structure or no content received. Raw response: ' + responseText);
                        }
                        
                        return JSON.parse(jsonText);
                    } catch (e) {
                        throw new Error(`Failed to parse JSON response. Raw response: ${responseText}`);
                    }

                } catch (error) {
                    lastError = error;
                    console.error("API call attempt failed:", error);
                    attempts++;
                    if (attempts < maxAttempts) {
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // Exponential backoff
                    }
                }
            }
            throw new Error(`Failed to call AI function after ${maxAttempts} attempts. Last error: ${lastError.message}`);
        };

        const applyColorScheme = (typeName) => {
            const root = document.documentElement;
            const isDark = root.classList.contains('dark');
            const scheme = typeColorSchemes[typeName] || typeColorSchemes.normal;
            const colors = isDark ? scheme.dark : scheme.light;
            for (const [property, value] of Object.entries(colors)) {
                root.style.setProperty(property, value);
            }
        };

        const themeManager = {
            init() {
                if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                this.updateIcon();
                allDOMElements.themeToggle.addEventListener('click', () => this.toggle());
            },
            toggle() {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.theme = 'light';
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.theme = 'dark';
                }
                this.updateIcon();
                applyColorScheme(currentPrimaryType);
            },
            updateIcon() {
                if (document.documentElement.classList.contains('dark')) {
                    allDOMElements.themeIconMoon.classList.add('hidden');
                    allDOMElements.themeIconSun.classList.remove('hidden');
                } else {
                    allDOMElements.themeIconSun.classList.add('hidden');
                    allDOMElements.themeIconMoon.classList.remove('hidden');
                }
            }
        };

        const populatePokemonList = async () => {
            allDOMElements.pokemonSearchInput.placeholder = "Loading Pokémon list...";
            try {
                const response = await fetch('https://pokeapi.co/api/v2/pokemon?limit=1025');
                if (!response.ok) throw new Error('Failed to fetch Pokémon list.');
                const data = await response.json();
                pokemonList = data.results.map(p => {
                    const urlParts = p.url.split('/');
                    const id = urlParts[urlParts.length - 2];
                    return { name: p.name, id: id };
                });
                allDOMElements.pokemonSearchInput.disabled = false;
                allDOMElements.pokemonSearchInput.placeholder = "Search for a Pokémon...";
                fetchPokemon(pokemonList[0].name); // Load first Pokémon
            } catch (error) {
                console.error(error);
                allDOMElements.pokemonSearchInput.placeholder = "Error loading Pokémon.";
            }
        };

        const fetchTypeData = async (typeName) => {
            if (typeDataCache.has(typeName)) return typeDataCache.get(typeName);
            try {
                const response = await fetch(`https://pokeapi.co/api/v2/type/${typeName}`);
                if (!response.ok) throw new Error(`Failed to fetch type data for ${typeName}`);
                const data = await response.json();
                typeDataCache.set(typeName, data.damage_relations);
                return data.damage_relations;
            } catch (error) {
                console.error(error);
                return null;
            }
        };

        const fetchPokemon = async (query) => {
            [allDOMElements.pokemonCard, allDOMElements.typeEffectivenessPanel, allDOMElements.matchupsPanel].forEach(p => p.classList.remove('hidden'));
            [allDOMElements.loader, allDOMElements.typeLoader, allDOMElements.matchupLoader, allDOMElements.pokedexEntryLoader].forEach(l => l.classList.remove('hidden'));
            [allDOMElements.errorMessage, allDOMElements.pokemonContent, allDOMElements.typeContent, allDOMElements.matchupContent].forEach(c => c.classList.add('hidden'));
            allDOMElements.pokedexEntry.textContent = '';
            allDOMElements.pokemonRoles.textContent = '';
            allDOMElements.pokemonGeneration.textContent = '';

            try {
                const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${query.toLowerCase()}`);
                if (!response.ok) throw new Error('Pokémon not found');
                const data = await response.json();
                
                displayPokemon(data);
                updateManualBuilder(data);
                updateMovesTab(data);
                fetchAndDisplayCommonRoles();
                
                const speciesResponse = await fetch(data.species.url);
                if (!speciesResponse.ok) throw new Error('Failed to fetch species data');
                const speciesData = await speciesResponse.json();
                currentPokemonSpeciesUrl = data.species.url; // Store species URL
                displayPokedexEntry(speciesData);
                updateFormSelector(speciesData, data.name);

                const currentPokemonTypes = data.types.map(t => t.type.name);
                currentTypeRelations = await Promise.all(currentPokemonTypes.map(fetchTypeData));
                currentPokemonIdForMatchup = data.id;
                currentTargetBst = data.stats.reduce((sum, stat) => sum + stat.base_stat, 0);

                calculateAndDisplayEffectiveness();
                findAndDisplayMatchups();

            } catch (error) {
                console.error(error);
                showError();
            } finally {
                allDOMElements.loader.classList.add('hidden');
            }
        };

        const calculateAndDisplayEffectiveness = () => {
            allDOMElements.typeContent.classList.add('hidden');
            allDOMElements.typeLoader.classList.remove('hidden');
            const advantages = new Set();
            currentTypeRelations.forEach(relation => {
                relation.double_damage_to.forEach(type => advantages.add(type.name));
            });
            const damageMultipliers = {};
            allTypeNames.forEach(t => damageMultipliers[t] = 1);
            for (const relation of currentTypeRelations) {
                relation.double_damage_from.forEach(t => damageMultipliers[t.name] *= 2);
                relation.half_damage_from.forEach(t => damageMultipliers[t.name] *= 0.5);
                relation.no_damage_from.forEach(t => damageMultipliers[t.name] *= 0);
            }
            const disadvantages = Object.entries(damageMultipliers).filter(([_, m]) => m >= 2).map(([t, _]) => t);
            displayEffectiveness(Array.from(advantages), disadvantages);
            allDOMElements.typeLoader.classList.add('hidden');
            allDOMElements.typeContent.classList.remove('hidden');
        };

        const findAndDisplayMatchups = async () => {
            allDOMElements.matchupContent.classList.add('hidden');
            allDOMElements.matchupLoader.classList.remove('hidden');
            const weakToTypes = new Set();
            currentTypeRelations.forEach(r => r.double_damage_from.forEach(t => weakToTypes.add(t.name)));
            const strongAgainstTypes = new Set();
            currentTypeRelations.forEach(r => r.double_damage_to.forEach(t => strongAgainstTypes.add(t.name)));
            const [goodMatchups, badMatchups] = await Promise.all([
                findPokemonByCriteria(weakToTypes, currentTargetBst, 3, currentPokemonIdForMatchup),
                findPokemonByCriteria(strongAgainstTypes, currentTargetBst, 3, currentPokemonIdForMatchup)
            ]);
            displayMatchupList(allDOMElements.goodMatchupsList, goodMatchups);
            displayMatchupList(allDOMElements.badMatchupsList, badMatchups);
            allDOMElements.matchupLoader.classList.add('hidden');
            allDOMElements.matchupContent.classList.remove('hidden');
        };

        const findPokemonByCriteria = async (targetTypes, targetBst, count, excludeId) => {
            const candidates = [];
            if (targetTypes.size === 0) return candidates;
            const checkedIds = new Set([excludeId]);
            let attempts = 0;
            const maxAttempts = 150;
            while (candidates.length < count && attempts < maxAttempts) {
                const randomId = Math.floor(Math.random() * 1025) + 1;
                if (checkedIds.has(randomId)) continue;
                checkedIds.add(randomId);
                attempts++;
                try {
                    const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${randomId}`);
                    if (!res.ok) continue;
                    const pokemon = await res.json();
                    const bst = pokemon.stats.reduce((sum, s) => sum + s.base_stat, 0);
                    if (Math.abs(bst - targetBst) <= 30) {
                        const types = pokemon.types.map(t => t.type.name);
                        if (types.some(t => targetTypes.has(t))) {
                            candidates.push(pokemon);
                        }
                    }
                } catch (err) {
                    console.error(`Failed to fetch matchup candidate ${randomId}`, err);
                }
            }
            return candidates;
        };

        const displayMatchupList = (listElement, candidates) => {
            listElement.innerHTML = '';
            if (candidates.length === 0) {
                listElement.innerHTML = `<span class="col-span-3 text-sm text-[var(--color-text-secondary)]">None found</span>`;
                return;
            }
            candidates.forEach(pokemon => {
                listElement.appendChild(createMatchupPokemonElement(pokemon));
            });
        };

        const createMatchupPokemonElement = (pokemon) => {
            const element = document.createElement('div');
            element.className = 'flex flex-col items-center cursor-pointer hover:scale-110 transition-transform';
            element.innerHTML = `<img src="${pokemon.sprites.front_default}" alt="${pokemon.name}" class="w-16 h-16" loading="lazy"><span class="text-xs capitalize">${pokemon.name}</span>`;
            element.addEventListener('click', () => {
                allDOMElements.pokemonSearchInput.value = pokemon.name;
                fetchPokemon(pokemon.name);
            });
            return element;
        };
        
        const displayEffectiveness = (advantages, disadvantages) => {
            allDOMElements.advantagesList.innerHTML = advantages.length > 0 ? advantages.map(createTypeBadge).join('') : `<span class="text-sm text-[var(--color-text-secondary)]">None</span>`;
            allDOMElements.disadvantagesList.innerHTML = disadvantages.length > 0 ? disadvantages.map(createTypeBadge).join('') : `<span class="text-sm text-[var(--color-text-secondary)]">None</span>`;
        };
        
        const createTypeBadge = (typeName) => {
            const color = typeColors[typeName] || 'bg-gray-400';
            return `<span class="type-badge ${color}">${typeName}</span>`;
        };

        const updateShinyDisplay = () => {
            allDOMElements.pokemonImage.src = isShiny ? currentPokemonSprites.shiny : currentPokemonSprites.default;
            if (isShiny) {
                allDOMElements.shinyToggleBtn.classList.add('shiny-active');
            } else {
                allDOMElements.shinyToggleBtn.classList.remove('shiny-active');
            }
        };

        const displayPokemon = (data) => {
            const { pokemonContent, errorMessage, pokemonImage, pokemonName, pokemonId, pokemonTypes, pokemonStats } = allDOMElements;
            
            isShiny = false; // Reset shiny state for new Pokémon
            currentPokemonSprites.default = data.sprites.other['official-artwork'].front_default || data.sprites.front_default;
            currentPokemonSprites.shiny = data.sprites.other['official-artwork'].front_shiny || data.sprites.front_shiny;
            
            currentPrimaryType = data.types[0].type.name;
            currentPokemonNameForBuild = data.name; // Store name for AI build
            currentBaseStats = {};
            data.stats.forEach(s => {
                currentBaseStats[showdownStatNames[s.stat.name].toLowerCase()] = s.base_stat;
            });
            applyColorScheme(currentPrimaryType);

            pokemonContent.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            
            updateShinyDisplay();

            pokemonImage.alt = data.name;
            pokemonName.textContent = data.name;
            pokemonId.textContent = `#${data.id.toString().padStart(3, '0')}`;
            pokemonTypes.innerHTML = data.types.map(t => createTypeBadge(t.type.name)).join('');
            
            pokemonStats.innerHTML = '';
            let bst = 0;
            data.stats.forEach(statInfo => {
                const statName = statNames[statInfo.stat.name] || statInfo.stat.name;
                const statValue = statInfo.base_stat;
                bst += statValue;
                const statPercent = (statValue / 255) * 100;
                const statElement = document.createElement('div');
                statElement.innerHTML = `<div class="flex justify-between mb-1"><span class="text-sm font-medium capitalize">${statName}</span><span class="text-sm font-bold">${statValue}</span></div><div class="w-full bg-black/10 rounded-full h-2.5"><div class="bg-[var(--color-accent)] h-2.5 rounded-full" style="width: ${statPercent}%"></div></div>`;
                pokemonStats.appendChild(statElement);
            });

            const bstElement = document.createElement('div');
            bstElement.className = 'pt-2 mt-2 border-t border-[var(--color-border)]';
            bstElement.innerHTML = `<div class="flex justify-between"><span class="text-sm font-medium">Total (BST)</span><span class="text-sm font-bold">${bst}</span></div>`;
            pokemonStats.appendChild(bstElement);
        };

        const displayPokedexEntry = (speciesData) => {
            const { pokedexEntry, pokedexEntryLoader, pokemonGeneration } = allDOMElements;
            pokedexEntryLoader.classList.add('hidden');

            const englishEntry = speciesData.flavor_text_entries.find(entry => entry.language.name === 'en');

            if (englishEntry) {
                const cleanedText = englishEntry.flavor_text.replace(/[\n\f\r]/g, ' ');
                pokedexEntry.textContent = cleanedText;
            } else {
                pokedexEntry.textContent = 'No Pokédex entry found for this Pokémon.';
            }
            
            if (speciesData.generation && speciesData.generation.name) {
                const generationString = speciesData.generation.name.replace('generation-', '').toUpperCase();
                pokemonGeneration.textContent = `First Introduced: Generation ${generationString}`;
            } else {
                pokemonGeneration.textContent = '';
            }
        };

        const formatVarietyName = (name) => {
            return name.split('-')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        };

        const updateFormSelector = (speciesData, currentFormName) => {
            const { formSelectorContainer, formSelector } = allDOMElements;
            const varieties = speciesData.varieties;

            if (varieties && varieties.length > 1) {
                formSelector.innerHTML = ''; // Clear previous options
                varieties.forEach(variety => {
                    const option = document.createElement('option');
                    option.value = variety.pokemon.name;
                    option.textContent = formatVarietyName(variety.pokemon.name);
                    formSelector.appendChild(option);
                });
                formSelector.value = currentFormName; // Set the current form as selected
                formSelectorContainer.classList.remove('hidden');
            } else {
                formSelectorContainer.classList.add('hidden');
            }
        };
        
        const showError = () => {
            allDOMElements.errorMessage.classList.remove('hidden');
            allDOMElements.pokemonContent.classList.add('hidden');
            allDOMElements.typeEffectivenessPanel.classList.add('hidden');
            allDOMElements.matchupsPanel.classList.add('hidden');
        }

        const tabs = [
            { button: allDOMElements.aiTab, panel: allDOMElements.aiPanel },
            { button: allDOMElements.manualTab, panel: allDOMElements.manualPanel },
            { button: allDOMElements.movesTab, panel: allDOMElements.movesPanel },
            { button: allDOMElements.teamBuilderTab, panel: allDOMElements.teamBuilderPanel },
            { button: allDOMElements.teamGeneratorTab, panel: allDOMElements.teamGeneratorPanel },
            { button: allDOMElements.teamFillerTab, panel: allDOMElements.teamFillerPanel },
            { button: allDOMElements.statCalculatorTab, panel: allDOMElements.statCalculatorPanel }
        ];

        const switchToTab = (tabButtonId) => {
            const targetTab = tabs.find(tab => tab.button.id === tabButtonId);
            if (targetTab) {
                tabs.forEach(tabInfo => {
                    tabInfo.button.classList.remove('tab-active');
                    tabInfo.button.classList.add('tab-inactive');
                    tabInfo.panel.classList.add('hidden');
                });
                targetTab.button.classList.remove('tab-inactive');
                targetTab.button.classList.add('tab-active');
                targetTab.panel.classList.remove('hidden');
            }
        };

        tabs.forEach(tabInfo => {
            tabInfo.button.addEventListener('click', () => switchToTab(tabInfo.button.id));
        });

        const selectRandomPokemon = () => {
            if (pokemonList.length > 0) {
                const randomIndex = Math.floor(Math.random() * pokemonList.length);
                const randomPokemon = pokemonList[randomIndex];
                allDOMElements.pokemonSearchInput.value = randomPokemon.name;
                fetchPokemon(randomPokemon.name);
            }
        };

        const handleSearchInput = (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const { searchResults } = allDOMElements;
            
            if (!searchTerm) {
                searchResults.classList.add('hidden');
                return;
            }

            const matches = pokemonList.filter(p => p.name.toLowerCase().includes(searchTerm) || p.id.startsWith(searchTerm)).slice(0, 50);
            
            if (matches.length > 0) {
                searchResults.innerHTML = matches.map(p => {
                    const capitalizedName = p.name.charAt(0).toUpperCase() + p.name.slice(1);
                    return `<div class="p-2 hover:bg-[var(--color-accent)] hover:text-white cursor-pointer" data-name="${p.name}">#${p.id.padStart(3, '0')} - ${capitalizedName}</div>`;
                }).join('');
                searchResults.classList.remove('hidden');
            } else {
                searchResults.classList.add('hidden');
            }
        };

        const handleResultClick = (e) => {
            if (e.target.matches('[data-name]')) {
                const name = e.target.dataset.name;
                allDOMElements.pokemonSearchInput.value = name;
                allDOMElements.searchResults.classList.add('hidden');
                fetchPokemon(name);
            }
        };

        // MODIFIED AI FUNCTIONS START HERE
        const generateAiBuild = async () => {
            if (!currentPokemonNameForBuild) {
                allDOMElements.aiBuildDisplay.innerHTML = `<p class="text-[var(--color-text-secondary)] text-center md:col-span-2 lg:col-span-3">Please select a Pokémon first.</p>`;
                return;
            }
            allDOMElements.aiBuildDisplay.innerHTML = `<p class="text-[var(--color-text-secondary)] text-center md:col-span-2 lg:col-span-3">Generating builds for ${currentPokemonNameForBuild}...</p>`;
            
            const useAnyAbility = allDOMElements.anyAbilityCheckbox.checked;
            const selectedRole = allDOMElements.roleSelector.value;

            let prompt = `Generate three distinct, competitively viable Pokémon builds for ${currentPokemonNameForBuild}.`;
            if (selectedRole && selectedRole !== 'any') {
                prompt += ` The builds should be tailored for a "${selectedRole}" role.`;
            }
            if (useAnyAbility) {
                prompt += " For the ability, you can choose any ability from the entire game that would be optimal, not just one the Pokémon can naturally have.";
            }
            prompt += " For each build, provide the build information in standard Pokémon Showdown format and a brief, one-sentence explanation for the build's strategy.";
            
            try {
                const payload = { 
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "build": { "type": "STRING" },
                                    "description": { "type": "STRING" }
                                },
                                required: ["build", "description"]
                            }
                        }
                    }
                };
                
                const builds = await callAIFunction(payload);
                
                allDOMElements.aiBuildDisplay.innerHTML = '';
                if (builds.length > 0) {
                    builds.forEach(buildData => {
                        const buildCard = document.createElement('div');
                        buildCard.className = 'build-card p-4 border border-[var(--color-border)] rounded-lg bg-black/5 dark:bg-black/20';
                        
                        const pre = document.createElement('pre');
                        pre.className = 'whitespace-pre-wrap text-sm';
                        pre.textContent = buildData.build;

                        const button = document.createElement('button');
                        button.textContent = 'Copy for Showdown/PKHeX';
                        button.className = 'copy-build-btn mt-4 w-full bg-[var(--color-accent)] hover:bg-[var(--color-accent-hover)] text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm';
                        
                        const details = document.createElement('details');
                        details.className = 'mt-2 text-sm';
                        details.innerHTML = `
                            <summary class="cursor-pointer text-[var(--color-accent)]">Build Explanation</summary>
                            <p class="mt-2 text-[var(--color-text-secondary)]">${buildData.description}</p>
                        `;

                        buildCard.appendChild(pre);
                        buildCard.appendChild(button);
                        buildCard.appendChild(details);
                        allDOMElements.aiBuildDisplay.appendChild(buildCard);
                    });
                } else {
                     allDOMElements.aiBuildDisplay.innerHTML = `<p class="text-[var(--color-text-secondary)] text-center md:col-span-2 lg:col-span-3">Could not generate builds from the response.</p>`;
                }
            } catch (error) {
                console.error("Error fetching AI build:", error);
                allDOMElements.aiBuildDisplay.innerHTML = `<p class="text-red-500 text-center md:col-span-2 lg:col-span-3">Sorry, an error occurred: ${error.message}</p>`;
            }
        };

        const fetchAndDisplayCommonRoles = async () => {
            if (!currentPokemonNameForBuild) return;

            allDOMElements.rolesLoader.classList.remove('hidden');
            allDOMElements.pokemonRoles.textContent = '';

            const prompt = `List up to three common competitive Pokémon roles for ${currentPokemonNameForBuild}. Examples: Physical Sweeper, Special Wall, Lead, etc. Provide just a comma-separated list.`;

            try {
                const payload = { 
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                             "type": "OBJECT",
                             "properties": {
                                 "roles": {
                                     "type": "ARRAY",
                                     "items": { "type": "STRING" }
                                 }
                             },
                             "required": ["roles"]
                        }
                    }
                };
                const result = await callAIFunction(payload);
                
                if (result.roles) {
                    allDOMElements.pokemonRoles.textContent = result.roles.join(', ');
                } else {
                    throw new Error('Unexpected API response structure.');
                }
            } catch (error) {
                console.error("Error fetching common roles:", error);
                allDOMElements.pokemonRoles.textContent = 'Could not determine roles.';
            } finally {
                allDOMElements.rolesLoader.classList.add('hidden');
            }
        };

        const generateTeam = async () => {
            if (!currentPokemonNameForBuild) {
                allDOMElements.teamGeneratorDisplay.innerHTML = `<p class="text-[var(--color-text-secondary)] text-center col-span-full">Please select a Pokémon first.</p>`;
                return;
            }

            allDOMElements.teamGeneratorDisplay.innerHTML = `<p class="text-[var(--color-text-secondary)] text-center col-span-full">Generating team with ${currentPokemonNameForBuild}...</p>`;
            const selectedRole = allDOMElements.teamGenRoleSelector.value;

            const prompt = `Generate a competitive Pokémon team of 5 Pokémon that synergize well with a ${currentPokemonNameForBuild} acting as a ${selectedRole}. Provide only a comma-separated list of the 5 Pokémon names.`;

            try {
                const payload = { 
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            "type": "OBJECT",
                            "properties": {
                                "team": {
                                    "type": "ARRAY",
                                    "items": { "type": "STRING" }
                                }
                            },
                            "required": ["team"]
                        }
                    }
                };
                const result = await callAIFunction(payload);
                if (result.team) {
                    const teamNames = result.team.map(name => name.trim().toLowerCase());
                    displayGeneratedTeam([currentPokemonNameForBuild, ...teamNames]);
                } else {
                     throw new Error('Unexpected API response structure.');
                }
            } catch (error) {
                console.error("Error generating team:", error);
                allDOMElements.teamGeneratorDisplay.innerHTML = `<p class="text-red-500 text-center col-span-full">Sorry, an error occurred: ${error.message}</p>`;
            }
        };
        
        const fillTeam = async () => {
            const userInput = allDOMElements.teamFillerInput.value;
            if (!userInput) {
                allDOMElements.teamFillerDisplay.innerHTML = `<p class="text-[var(--color-text-secondary)] text-center col-span-full">Please enter at least one Pokémon.</p>`;
                return;
            }

            const existingTeam = userInput.split(',').map(name => name.trim()).filter(name => name);
            if (existingTeam.length === 0 || existingTeam.length > 5) {
                 allDOMElements.teamFillerDisplay.innerHTML = `<p class="text-[var(--color-text-secondary)] text-center col-span-full">Please enter between 1 and 5 Pokémon names.</p>`;
                 return;
            }

            const numToFill = 6 - existingTeam.length;
            allDOMElements.teamFillerDisplay.innerHTML = `<p class="text-[var(--color-text-secondary)] text-center col-span-full">Finding ${numToFill} Pokémon to complete your team...</p>`;
            
            const prompt = `A Pokémon team currently consists of: ${existingTeam.join(', ')}. Suggest ${numToFill} more Pokémon to create a competitively viable and synergistic team of 6. Provide only a comma-separated list of the suggested Pokémon names.`;

             try {
                const payload = { 
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            "type": "OBJECT",
                            "properties": {
                                "fillTeam": {
                                    "type": "ARRAY",
                                    "items": { "type": "STRING" }
                                }
                            },
                            "required": ["fillTeam"]
                        }
                    }
                };
                const result = await callAIFunction(payload);
                
                if (result.fillTeam) {
                    const newTeamNames = result.fillTeam.map(name => name.trim().toLowerCase());
                    const fullTeam = [...existingTeam, ...newTeamNames];
                    displayFilledTeam(fullTeam);
                } else {
                     throw new Error('Unexpected API response structure.');
                }
            } catch (error) {
                console.error("Error filling team:", error);
                allDOMElements.teamFillerDisplay.innerHTML = `<p class="text-red-500 text-center col-span-full">Sorry, an error occurred: ${error.message}</p>`;
            }
        };

        const allocateTeams = async () => {
            if (teamBuilderSelection.length < 3) {
                allDOMElements.teamBuilderResults.innerHTML = `<p class="text-[var(--color-text-secondary)] text-center col-span-full">Please select at least 3 Pokémon to allocate.</p>`;
                return;
            }

            allDOMElements.teamBuilderResults.innerHTML = `<p class="text-[var(--color-text-secondary)] text-center col-span-full">Allocating teams...</p>`;
            const pokemonNames = teamBuilderSelection.map(p => p.name).join(', ');
            const prompt = `I have a pool of the following Pokémon: ${pokemonNames}. Use these Pokémon as a core to build three distinct, competitively viable teams of six. You must use the Pokémon from my pool, distributing them among the three teams, and then fill the remaining slots on each team with other Pokémon that have good synergy. Each of the three final teams must have exactly six Pokémon.`;

            try {
                 const payload = { 
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "team1": { type: "ARRAY", items: { type: "STRING" } },
                                "team2": { type: "ARRAY", items: { type: "STRING" } },
                                "team3": { type: "ARRAY", items: { type: "STRING" } }
                            },
                            required: ["team1", "team2", "team3"]
                        }
                    }
                };
                
                const teams = await callAIFunction(payload);

                if (teams) {
                    displayAllocatedTeams(teams);
                } else {
                    throw new Error('Unexpected API response structure.');
                }
            } catch (error) {
                console.error("Error allocating teams:", error);
                allDOMElements.teamBuilderResults.innerHTML = `<p class="text-red-500 text-center col-span-full">Sorry, an error occurred: ${error.message}</p>`;
            }
        };

        // MODIFIED AI FUNCTIONS END HERE
        
        const populateAbilityDropdown = () => {
            const useAny = allDOMElements.manualAnyAbilityCheckbox.checked;
            const abilitiesToShow = useAny ? allAbilitiesList : currentPokemonNaturalAbilities;
            
            allDOMElements.abilitySelector.innerHTML = '';
            abilitiesToShow.forEach(abilityName => {
                const option = document.createElement('option');
                option.value = abilityName;
                option.textContent = abilityName.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                allDOMElements.abilitySelector.appendChild(option);
            });
        };

        const populateMoveDropdowns = () => {
            const useAny = allDOMElements.manualAnyMoveCheckbox.checked;
            const movesToShow = useAny ? allMovesList : currentPokemonMoves;
            const sortedMoves = [...movesToShow].sort();
            
            allDOMElements.moveSelectors.forEach(selector => {
                const selectedValue = selector.value;
                selector.innerHTML = ''; // Clear previous moves
                
                const defaultOption = document.createElement('option');
                defaultOption.textContent = 'Select a move...';
                defaultOption.value = '';
                selector.appendChild(defaultOption);

                sortedMoves.forEach(moveName => {
                    const option = document.createElement('option');
                    option.value = moveName;
                    option.textContent = moveName.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                    selector.appendChild(option);
                });
                selector.value = selectedValue;
            });
        };

        const updateManualBuilder = (data) => {
            // Store natural abilities and populate dropdown
            currentPokemonNaturalAbilities = data.abilities.map(abilityInfo => abilityInfo.ability.name);
            allDOMElements.manualAnyAbilityCheckbox.checked = false; // Reset checkbox
            populateAbilityDropdown();

            // Moves
            currentPokemonMoves = data.moves.map(moveInfo => moveInfo.move.name);
            allDOMElements.manualAnyMoveCheckbox.checked = false; // Reset checkbox
            populateMoveDropdowns();
            
            calculateAllStats();
        };

        const setupManualBuilder = async () => {
            // Natures
            const natures = ["Hardy", "Lonely", "Brave", "Adamant", "Naughty", "Bold", "Docile", "Relaxed", "Impish", "Lax", "Timid", "Hasty", "Serious", "Jolly", "Naive", "Modest", "Mild", "Quiet", "Bashful", "Rash", "Calm", "Gentle", "Sassy", "Careful", "Quirky"];
            allDOMElements.natureSelector.innerHTML = natures.map(n => `<option value="${n.toLowerCase()}">${n}</option>`).join('');
            allDOMElements.movesTabNatureSelector.innerHTML = natures.map(n => `<option value="${n.toLowerCase()}">${n}</option>`).join('');

            // Tera Types
            allDOMElements.teraTypeSelector.innerHTML = allTypeNames.map(t => `<option value="${t}">${t.charAt(0).toUpperCase() + t.slice(1)}</option>`).join('');
            
            // EVs and IVs
            const statsConfig = [
                { key: 'hp', display: 'HP', showdown: 'HP' },
                { key: 'atk', display: 'Atk', showdown: 'Atk' },
                { key: 'def', display: 'Def', showdown: 'Def' },
                { key: 'spa', display: 'SpA', showdown: 'SpA' },
                { key: 'spd', display: 'SpD', showdown: 'SpD' },
                { key: 'spe', display: 'Spe', showdown: 'Spe' }
            ];

            allDOMElements.evInputsContainer.innerHTML = statsConfig.map(stat => `
                <div class="grid grid-cols-3 gap-2 items-center">
                    <label for="ev-${stat.key}">${stat.display}</label>
                    <input type="range" min="0" max="252" step="4" value="0" class="w-full ev-slider" data-stat="${stat.key}">
                    <input type="number" id="ev-${stat.key}" min="0" max="252" step="4" value="0" class="custom-input p-1 w-16 ev-input" data-stat="${stat.key}" data-showdown-name="${stat.showdown}">
                </div>
            `).join('');
            allDOMElements.ivInputsContainer.innerHTML = statsConfig.map(stat => `
                 <div class="grid grid-cols-2 gap-2 items-center">
                    <label for="iv-${stat.key}">${stat.display}</label>
                    <input type="number" id="iv-${stat.key}" min="0" max="31" value="31" class="custom-input p-1 w-16 iv-input" data-stat="${stat.key}" data-showdown-name="${stat.showdown}">
                </div>
            `).join('');

            // Fetch All Abilities, and All Moves
            try {
                const [abilityResponse, moveResponse] = await Promise.all([
                    fetch('https://pokeapi.co/api/v2/ability?limit=1000'),
                    fetch('https://pokeapi.co/api/v2/move?limit=1000')
                ]);
                const abilityData = await abilityResponse.json();
                const moveData = await moveResponse.json();

                allAbilitiesList = abilityData.results.map(ability => ability.name).sort();
                allMovesList = moveData.results.map(move => move.name).sort();

                await fetchAllHoldableItems();

            } catch (error) {
                console.error("Failed to fetch builder data:", error);
            }
        };

        const fetchAllHoldableItems = async () => {
            const holdableCategories = [
                'held-items', 'choice', 'effort-training', 'species-specific', 
                'type-enhancement', 'healing', 'pp-recovery', 'stat-boosts', 
                'scarves', 'seeds', 'memories', 'plates', 'gems', 'mega-stones'
            ];
            
            try {
                const categoryPromises = holdableCategories.map(category => 
                    fetch(`https://pokeapi.co/api/v2/item-category/${category}/`).then(res => {
                        if (!res.ok) {
                            console.warn(`Could not fetch item category: ${category}. It might not exist.`);
                            return { items: [] }; // Return a default structure to avoid breaking Promise.all
                        }
                        return res.json();
                    })
                );
                const categoriesData = await Promise.all(categoryPromises);
                
                const itemSet = new Set();
                categoriesData.forEach(category => {
                    if (category && category.items) {
                        category.items.forEach(item => itemSet.add(item.name));
                    }
                });
                
                itemList = Array.from(itemSet).sort();
                populateItemDropdowns();

            } catch (error) {
                console.error("Failed to fetch holdable items:", error);
            }
        };

        const populateItemDropdowns = () => {
            const selectors = [allDOMElements.itemSelector, allDOMElements.movesTabItemSelector];
            selectors.forEach(selector => {
                if (!selector) return;
                selector.innerHTML = ''; // Clear previous items

                const defaultOption = document.createElement('option');
                defaultOption.textContent = 'Select an item...';
                defaultOption.value = '';
                selector.appendChild(defaultOption);

                itemList.forEach(itemName => {
                    const option = document.createElement('option');
                    option.value = itemName;
                    option.textContent = itemName.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                    selector.appendChild(option);
                });
            });
        };

        const handleEvChange = () => {
            let total = 0;
            document.querySelectorAll('.ev-input').forEach(input => {
                let value = parseInt(input.value) || 0;
                if (value > 252) value = 252;
                if (value < 0) value = 0;
                input.value = value;
                total += value;
            });
            
            if (total > 510) {
                 allDOMElements.evRemaining.classList.add('text-red-500');
            } else {
                 allDOMElements.evRemaining.classList.remove('text-red-500');
            }
            allDOMElements.evRemaining.textContent = 510 - total;

            document.querySelectorAll('.ev-input').forEach(input => {
                const stat = input.dataset.stat;
                document.querySelector(`.ev-slider[data-stat="${stat}"]`).value = input.value;
            });
            calculateAllStats();
        };

        const calculateAllStats = () => {
            if (Object.keys(currentBaseStats).length === 0) return;

            const level = parseInt(allDOMElements.levelInput.value) || 100;
            const nature = allDOMElements.natureSelector.value;
            const natureMod = natureMultipliers[nature] || {};

            const finalStats = {};
            const statOrder = ['hp', 'atk', 'def', 'spa', 'spd', 'spe'];
            const fullStatNames = ['HP', 'Attack', 'Defense', 'Sp. Atk', 'Sp. Def', 'Speed'];


            statOrder.forEach(stat => {
                const base = currentBaseStats[stat];
                const iv = parseInt(document.getElementById(`iv-${stat}`).value) || 0;
                const ev = parseInt(document.getElementById(`ev-${stat}`).value) || 0;

                let total;
                if (stat === 'hp') {
                    // Shedinja case
                    if (base === 1) {
                        total = 1;
                    } else {
                        total = Math.floor(((2 * base + iv + Math.floor(ev / 4)) * level) / 100) + level + 10;
                    }
                } else {
                    const preNature = Math.floor(((2 * base + iv + Math.floor(ev / 4)) * level) / 100) + 5;
                    total = Math.floor(preNature * (natureMod[stat] || 1));
                }
                finalStats[stat] = total;
            });
            
            allDOMElements.calculatedStatsDisplay.innerHTML = statOrder.map((stat, index) => `
                <div class="flex justify-between text-sm">
                    <span class="font-medium">${fullStatNames[index]}</span>
                    <span class="font-bold">${finalStats[stat]}</span>
                </div>
            `).join('');
        };
        
        function copyToClipboard(text, button) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            } catch (err) {
                const originalText = button.textContent;
                button.textContent = 'Failed to copy';
                 setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            }
            document.body.removeChild(textarea);
        }

        const generateManualBuildText = () => {
            let build = '';
            const name = currentPokemonNameForBuild.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join('-');
            const item = allDOMElements.itemSelector.value;
            build += `${name}${item ? ' @ ' + item.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') : ''}\n`;
            
            const ability = allDOMElements.abilitySelector.options[allDOMElements.abilitySelector.selectedIndex].textContent;
            build += `Ability: ${ability}\n`;
            
            if (isShiny) build += 'Shiny: Yes\n';

            const teraType = allDOMElements.teraTypeSelector.options[allDOMElements.teraTypeSelector.selectedIndex].textContent;
            build += `Tera Type: ${teraType}\n`;

            const evs = [];
            document.querySelectorAll('.ev-input').forEach(input => {
                const value = parseInt(input.value);
                if (value > 0) {
                    const showdownName = input.dataset.showdownName;
                    evs.push(`${value} ${showdownName}`);
                }
            });
            if (evs.length > 0) build += `EVs: ${evs.join(' / ')}\n`;

            const nature = allDOMElements.natureSelector.options[allDOMElements.natureSelector.selectedIndex].textContent;
            build += `${nature} Nature\n`;

            const ivs = [];
            document.querySelectorAll('.iv-input').forEach(input => {
                const value = parseInt(input.value);
                if (value < 31) {
                    const showdownName = input.dataset.showdownName;
                    ivs.push(`${value} ${showdownName}`);
                }
            });
            if (ivs.length > 0) build += `IVs: ${ivs.join(' / ')}\n`;

            allDOMElements.moveSelectors.forEach(selector => {
                if (selector.value) {
                    build += `- ${selector.options[selector.selectedIndex].textContent}\n`;
                }
            });

            return build.trim();
        };

        // --- Moves/Abilities Tab Functions ---
        const updateMovesTab = (data) => {
            allDOMElements.movesTabAnyAbilityCheckbox.checked = false;
            populateMovesTabAbilities();
            allDOMElements.movesTabAnyMoveCheckbox.checked = false;
            populateMovesTabMovesList();
            
            if (currentPokemonNaturalAbilities.length > 0) {
                allDOMElements.movesTabAbilitySelector.selectedIndex = 0;
                displayAbilityDescription(allDOMElements.movesTabAbilitySelector.value);
            } else {
                 allDOMElements.movesTabAbilityDescription.innerHTML = `<p class="text-[var(--color-text-secondary)]">No abilities to display.</p>`;
            }

            if (allDOMElements.movesTabNatureSelector.options.length > 0) {
                 allDOMElements.movesTabNatureSelector.selectedIndex = 0;
                 displayNatureDescription(allDOMElements.movesTabNatureSelector.value);
            }

            allDOMElements.movesTabItemDescription.innerHTML = `<p class="text-[var(--color-text-secondary)]">Select an item to see its description.</p>`;
            allDOMElements.movesTabMoveDescription.innerHTML = `<p class="text-[var(--color-text-secondary)]">Select a move to see its details.</p>`;
        };

        const populateMovesTabAbilities = () => {
            const useAny = allDOMElements.movesTabAnyAbilityCheckbox.checked;
            const abilitiesToShow = useAny ? allAbilitiesList : currentPokemonNaturalAbilities;
            const selector = allDOMElements.movesTabAbilitySelector;
            
            selector.innerHTML = '';
            abilitiesToShow.forEach(abilityName => {
                const option = document.createElement('option');
                option.value = abilityName;
                option.textContent = abilityName.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                selector.appendChild(option);
            });
        };

        const populateMovesTabMovesList = () => {
            const listContainer = allDOMElements.movesTabMovesList;
            const useAny = allDOMElements.movesTabAnyMoveCheckbox.checked;
            const movesToShow = useAny ? allMovesList : currentPokemonMoves;
            const sortedMoves = [...movesToShow].sort();

            listContainer.innerHTML = '';

            if (sortedMoves.length === 0) {
                listContainer.innerHTML = `<p class="text-[var(--color-text-secondary)]">No moves to display.</p>`;
                return;
            }

            sortedMoves.forEach(moveName => {
                const moveButton = document.createElement('button');
                moveButton.className = 'w-full text-left p-2 rounded-md hover:bg-[var(--color-accent)] hover:text-white transition-colors text-sm';
                moveButton.textContent = moveName.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                moveButton.dataset.moveName = moveName;
                listContainer.appendChild(moveButton);
            });
        };

        const displayAbilityDescription = async (abilityName) => {
            const displayArea = allDOMElements.movesTabAbilityDescription;
            if (!abilityName) {
                displayArea.innerHTML = `<p class="text-[var(--color-text-secondary)]">Select an ability to see its description.</p>`;
                return;
            }
            displayArea.innerHTML = `<p class="text-[var(--color-text-secondary)]">Fetching description...</p>`;
            try {
                const response = await fetch(`https://pokeapi.co/api/v2/ability/${abilityName}`);
                if (!response.ok) throw new Error('Ability not found');
                const data = await response.json();
                const englishEntry = data.effect_entries.find(entry => entry.language.name === 'en');
                displayArea.innerHTML = englishEntry ? englishEntry.short_effect : 'No English description available.';
            } catch (error) {
                console.error(error);
                displayArea.innerHTML = 'Could not load ability description.';
            }
        };

        const displayItemDescription = async (itemName) => {
            const displayArea = allDOMElements.movesTabItemDescription;
            if (!itemName) {
                displayArea.innerHTML = `<p class="text-[var(--color-text-secondary)]">Select an item to see its description.</p>`;
                return;
            }
            displayArea.innerHTML = `<p class="text-[var(--color-text-secondary)]">Fetching description...</p>`;
            try {
                const response = await fetch(`https://pokeapi.co/api/v2/item/${itemName}`);
                if (!response.ok) throw new Error('Item not found');
                const data = await response.json();
                const englishEntry = data.effect_entries.find(entry => entry.language.name === 'en');
                displayArea.innerHTML = englishEntry ? englishEntry.short_effect : 'No English description available.';
            } catch (error) {
                console.error(error);
                displayArea.innerHTML = 'Could not load item description.';
            }
        };

        const displayNatureDescription = (natureName) => {
            const displayArea = allDOMElements.movesTabNatureDescription;
            const natureData = natureMultipliers[natureName];
            const statMap = { atk: 'Attack', def: 'Defense', spa: 'Sp. Atk', spd: 'Sp. Def', spe: 'Speed' };
            
            if (natureData) {
                const increasedStat = Object.keys(natureData).find(key => natureData[key] === 1.1);
                const decreasedStat = Object.keys(natureData).find(key => natureData[key] === 0.9);
                displayArea.innerHTML = `
                    <p><span class="font-semibold">Increases:</span> ${statMap[increasedStat]}</p>
                    <p><span class="font-semibold">Decreases:</span> ${statMap[decreasedStat]}</p>
                `;
            } else {
                displayArea.innerHTML = `<p class="font-semibold">Neutral Nature</p><p>No stats are affected.</p>`;
            }
        };

        const displayMoveDescription = async (moveName) => {
            const displayArea = allDOMElements.movesTabMoveDescription;
            if (!moveName) {
                displayArea.innerHTML = `<p class="text-[var(--color-text-secondary)]">Select a move to see its details.</p>`;
                return;
            }
            displayArea.innerHTML = `<p class="text-[var(--color-text-secondary)]">Fetching details...</p>`;
            try {
                const response = await fetch(`https://pokeapi.co/api/v2/move/${moveName}`);
                if (!response.ok) throw new Error('Move not found');
                const data = await response.json();
                const englishEntry = data.effect_entries.find(entry => entry.language.name === 'en');
                const description = englishEntry ? englishEntry.short_effect.replace('$effect_chance', data.effect_chance) : 'No English description available.';

                displayArea.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold capitalize">${data.name.replace('-', ' ')}</h4>
                        ${createTypeBadge(data.type.name)}
                    </div>
                    <p class="text-sm mb-2">${description}</p>
                    <div class="grid grid-cols-3 gap-2 text-center text-sm border-t border-[var(--color-border)] pt-2">
                        <div><span class="font-semibold">Power</span><br>${data.power || '—'}</div>
                        <div><span class="font-semibold">Accuracy</span><br>${data.accuracy || '—'}</div>
                        <div><span class="font-semibold">PP</span><br>${data.pp || '—'}</div>
                    </div>
                `;
            } catch (error) {
                console.error(error);
                displayArea.innerHTML = 'Could not load move details.';
            }
        };

        const displayGeneratedTeam = async (teamNames) => {
            const displayArea = allDOMElements.teamGeneratorDisplay;
            displayArea.innerHTML = '';
            
            for (const name of teamNames) {
                try {
                    const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${name.toLowerCase().trim()}`);
                    if (res.ok) {
                        const data = await res.json();
                        displayArea.appendChild(createMatchupPokemonElement(data));
                    }
                } catch (err) {
                    console.error(`Could not fetch data for ${name}`, err);
                }
            }
        };

        const displayFilledTeam = async (teamNames) => {
            const displayArea = allDOMElements.teamFillerDisplay;
            displayArea.innerHTML = '';
            
            for (const name of teamNames) {
                try {
                    const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${name.toLowerCase().trim()}`);
                    if (res.ok) {
                        const data = await res.json();
                        displayArea.appendChild(createMatchupPokemonElement(data));
                    } else {
                        // If a pokemon isn't found, display its name as text
                        const errorElement = document.createElement('div');
                        errorElement.className = 'flex flex-col items-center justify-center text-center p-2 border border-dashed border-[var(--color-border)] rounded-lg';
                        errorElement.innerHTML = `<span class="text-xs capitalize text-[var(--color-text-secondary)]">${name}</span><span class="text-xs text-red-500">(Not Found)</span>`;
                        displayArea.appendChild(errorElement);
                    }
                } catch (err) {
                    console.error(`Could not fetch data for ${name}`, err);
                }
            }
        };

        // --- Team Builder Functions ---
        const handleTeamBuilderSearch = (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const searchResultsEl = allDOMElements.teamBuilderSearchResults;
            if (!searchTerm) {
                searchResultsEl.classList.add('hidden');
                return;
            }
            const matches = pokemonList.filter(p => p.name.toLowerCase().includes(searchTerm)).slice(0, 50);
            if (matches.length > 0) {
                searchResultsEl.innerHTML = matches.map(p => {
                    const capitalizedName = p.name.charAt(0).toUpperCase() + p.name.slice(1);
                    return `<div class="p-2 hover:bg-[var(--color-accent)] hover:text-white cursor-pointer" data-name="${p.name}" data-id="${p.id}">#${p.id.padStart(3, '0')} - ${capitalizedName}</div>`;
                }).join('');
                searchResultsEl.classList.remove('hidden');
            } else {
                searchResultsEl.classList.add('hidden');
            }
        };

        const addPokemonToSelection = (pokemon) => {
            if (teamBuilderSelection.length >= 12) {
                // Replaced alert() with a console message for a better user experience
                console.error("You can select a maximum of 12 Pokémon.");
                return;
            }
            if (teamBuilderSelection.some(p => p.id === pokemon.id)) {
                // Already in the list, do nothing
                return;
            }
            teamBuilderSelection.push(pokemon);
            renderSelectionPool();
        };

        const removePokemonFromSelection = (pokemonId) => {
            teamBuilderSelection = teamBuilderSelection.filter(p => p.id !== pokemonId);
            renderSelectionPool();
        };

        const renderSelectionPool = () => {
            const poolEl = allDOMElements.selectionPool;
            poolEl.innerHTML = '';
            if (teamBuilderSelection.length === 0) {
                poolEl.appendChild(allDOMElements.selectionPoolPlaceholder);
                allDOMElements.selectionPoolPlaceholder.classList.remove('hidden');
            } else {
                allDOMElements.selectionPoolPlaceholder.classList.add('hidden');
                teamBuilderSelection.forEach(pokemon => {
                    const spriteContainer = document.createElement('div');
                    spriteContainer.className = 'relative group';
                    spriteContainer.innerHTML = `
                        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${pokemon.id}.png" alt="${pokemon.name}" class="w-16 h-16 mx-auto" loading="lazy">
                        <button data-id="${pokemon.id}" class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity">&times;</button>
                        <span class="text-xs capitalize text-center block">${pokemon.name}</span>
                    `;
                    poolEl.appendChild(spriteContainer);
                });
            }
        };

        const displayAllocatedTeams = async (teams) => {
            const resultsEl = allDOMElements.teamBuilderResults;
            resultsEl.innerHTML = '';

            for (let i = 1; i <= 3; i++) {
                const teamKey = `team${i}`;
                const teamData = teams[teamKey];
                
                const teamContainer = document.createElement('div');
                teamContainer.className = 'border border-[var(--color-border)] rounded-lg p-4';
                teamContainer.innerHTML = `<h4 class="font-bold text-lg mb-2 text-center">Team ${i}</h4>`;
                
                const pokemonGrid = document.createElement('div');
                pokemonGrid.className = 'grid grid-cols-2 sm:grid-cols-3 gap-2';
                
                if (teamData && teamData.length > 0) {
                    for (const name of teamData) {
                        try {
                            const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${name.toLowerCase().trim()}`);
                            if (res.ok) {
                                const data = await res.json();
                                pokemonGrid.appendChild(createMatchupPokemonElement(data));
                            }
                        } catch (err) {
                            console.error(`Could not fetch data for ${name}`, err);
                        }
                    }
                }
                teamContainer.appendChild(pokemonGrid);
                resultsEl.appendChild(teamContainer);
            }
        };

        // --- Stat Calculator Functions ---
        const setupStatCalculator = () => {
            const panel = allDOMElements.statCalculatorPanel;
            const natures = ["Hardy", "Lonely", "Brave", "Adamant", "Naughty", "Bold", "Docile", "Relaxed", "Impish", "Lax", "Timid", "Hasty", "Serious", "Jolly", "Naive", "Modest", "Mild", "Quiet", "Bashful", "Rash", "Calm", "Gentle", "Sassy", "Careful", "Quirky"];
            const statsConfig = [
                { key: 'hp', display: 'HP' }, { key: 'atk', display: 'Atk' }, { key: 'def', display: 'Def' },
                { key: 'spa', display: 'SpA' }, { key: 'spd', display: 'SpD' }, { key: 'spe', display: 'Spe' }
            ];

            panel.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-8 gap-y-6">
                    <!-- Left Side: Inputs -->
                    <div class="space-y-6">
                        <!-- Core -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="calc-level" class="block text-sm font-medium mb-1">Level</label>
                                <input type="number" id="calc-level" min="1" max="100" value="100" class="custom-input w-full p-2">
                            </div>
                            <div>
                                <label for="calc-nature" class="block text-sm font-medium mb-1">Nature</label>
                                <select id="calc-nature" class="custom-select w-full p-2">
                                    ${natures.map(n => `<option value="${n.toLowerCase()}">${n}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <!-- Base Stats -->
                        <div>
                            <h4 class="text-sm font-medium mb-2">Base Stats</h4>
                            <div class="grid grid-cols-3 gap-2">
                                ${statsConfig.map(s => `
                                    <div class="text-center">
                                        <label for="calc-base-${s.key}" class="block text-xs font-medium mb-1">${s.display}</label>
                                        <input type="number" id="calc-base-${s.key}" min="1" max="255" value="100" class="custom-input w-full p-1 text-center">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <!-- EVs -->
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <h4 class="text-sm font-medium">Effort Values (EVs)</h4>
                                <p class="text-sm">Remaining: <span id="calc-ev-remaining">510</span></p>
                            </div>
                            <div class="space-y-2 text-xs">
                                ${statsConfig.map(s => `
                                    <div class="grid grid-cols-3 gap-2 items-center">
                                        <label for="calc-ev-${s.key}">${s.display}</label>
                                        <input type="range" min="0" max="252" step="4" value="0" class="w-full calc-ev-slider" data-stat="${s.key}">
                                        <input type="number" id="calc-ev-${s.key}" min="0" max="252" step="4" value="0" class="custom-input p-1 w-16 calc-ev-input" data-stat="${s.key}">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <!-- IVs -->
                        <div>
                            <h4 class="text-sm font-medium mb-2">Individual Values (IVs)</h4>
                            <div class="grid grid-cols-3 gap-2">
                                ${statsConfig.map(s => `
                                    <div class="text-center">
                                        <label for="calc-iv-${s.key}" class="block text-xs font-medium mb-1">${s.display}</label>
                                        <input type="number" id="calc-iv-${s.key}" min="0" max="31" value="31" class="custom-input w-full p-1 text-center">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <!-- Right Side: Calculated Stats -->
                    <div class="flex flex-col justify-center items-center">
                         <h3 class="text-xl font-semibold text-center mb-4">Calculated Stats</h3>
                         <div id="calc-results" class="w-full max-w-xs p-4 border border-[var(--color-border)] rounded-lg space-y-2">
                            <!-- Results here -->
                         </div>
                         <button id="reset-calc-btn" class="mt-4 w-full max-w-xs bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">
                            Reset Fields
                         </button>
                    </div>
                </div>
            `;
            // Add the new button to the DOM elements object after it's created
            allDOMElements.resetCalcBtn = document.getElementById('reset-calc-btn');
            allDOMElements.resetCalcBtn.addEventListener('click', resetStatCalculator);
            
            calculateCustomStats(); // Initial calculation
        };

        const resetStatCalculator = () => {
            document.getElementById('calc-level').value = 100;
            document.getElementById('calc-nature').value = 'hardy';

            const statsConfig = ['hp', 'atk', 'def', 'spa', 'spd', 'spe'];
            statsConfig.forEach(stat => {
                document.getElementById(`calc-base-${stat}`).value = 100;
                document.getElementById(`calc-iv-${stat}`).value = 31;
                document.getElementById(`calc-ev-${stat}`).value = 0;
            });
            
            handleCalcEvChange(); // This will also trigger calculateCustomStats
        };

        const calculateCustomStats = () => {
            const level = parseInt(document.getElementById('calc-level').value) || 100;
            const nature = document.getElementById('calc-nature').value;
            const natureMod = natureMultipliers[nature] || {};

            const finalStats = {};
            const statOrder = ['hp', 'atk', 'def', 'spa', 'spd', 'spe'];
            const fullStatNames = ['HP', 'Attack', 'Defense', 'Sp. Atk', 'Sp. Def', 'Speed'];

            statOrder.forEach(stat => {
                const base = parseInt(document.getElementById(`calc-base-${stat}`).value) || 0;
                const iv = parseInt(document.getElementById(`calc-iv-${stat}`).value) || 0;
                const ev = parseInt(document.getElementById(`calc-ev-${stat}`).value) || 0;
                
                let total;
                if (stat === 'hp') {
                    total = (base === 1) ? 1 : Math.floor(((2 * base + iv + Math.floor(ev / 4)) * level) / 100) + level + 10;
                } else {
                    const preNature = Math.floor(((2 * base + iv + Math.floor(ev / 4)) * level) / 100) + 5;
                    total = Math.floor(preNature * (natureMod[stat] || 1));
                }
                finalStats[stat] = total;
            });
            
            document.getElementById('calc-results').innerHTML = statOrder.map((stat, index) => `
                <div class="flex justify-between text-sm">
                    <span class="font-medium">${fullStatNames[index]}</span>
                    <span class="font-bold">${finalStats[stat]}</span>
                </div>
            `).join('');
        };

        const handleCalcEvChange = () => {
            let total = 0;
            document.querySelectorAll('.calc-ev-input').forEach(input => {
                let value = parseInt(input.value) || 0;
                if (value > 252) value = 252;
                if (value < 0) value = 0;
                input.value = value;
                total += value;
            });
            
            const remainingEl = document.getElementById('calc-ev-remaining');
            if (total > 510) {
                 remainingEl.classList.add('text-red-500');
            } else {
                 remainingEl.classList.remove('text-red-500');
            }
            remainingEl.textContent = 510 - total;

            document.querySelectorAll('.calc-ev-input').forEach(input => {
                const stat = input.dataset.stat;
                document.querySelector(`.calc-ev-slider[data-stat="${stat}"]`).value = input.value;
            });
            calculateCustomStats();
        };

        const sendStatsToCalculator = () => {
            if (Object.keys(currentBaseStats).length === 0) return;

            const statKeys = ['hp', 'atk', 'def', 'spa', 'spd', 'spe'];

            statKeys.forEach(key => {
                const baseStatValue = currentBaseStats[key] || 0;
                const baseStatInput = document.getElementById(`calc-base-${key}`);
                if (baseStatInput) {
                    baseStatInput.value = baseStatValue;
                }
            });

            switchToTab('statCalculatorTab');
            calculateCustomStats();
        };

        // --- Evolution Chain Functions ---
        const handleShowEvolution = async () => {
            if (!currentPokemonSpeciesUrl) return;
            const { evolutionModal, evolutionChainDisplay } = allDOMElements;
            
            evolutionChainDisplay.innerHTML = `<p class="text-[var(--color-text-secondary)]">Fetching evolution line...</p>`;
            evolutionModal.classList.remove('hidden');

            try {
                const speciesRes = await fetch(currentPokemonSpeciesUrl);
                if (!speciesRes.ok) throw new Error('Failed to fetch species data for evolution.');
                const speciesData = await speciesRes.json();

                const evolutionChainRes = await fetch(speciesData.evolution_chain.url);
                if (!evolutionChainRes.ok) throw new Error('Failed to fetch evolution chain data.');
                const evolutionData = await evolutionChainRes.json();

                const evolutionLine = parseEvolutionChain(evolutionData.chain);
                const pokemonDataPromises = evolutionLine.map(name => fetch(`https://pokeapi.co/api/v2/pokemon/${name}`).then(res => res.json()));
                const pokemonDataArray = await Promise.all(pokemonDataPromises);

                evolutionChainDisplay.innerHTML = '';
                pokemonDataArray.forEach((pokemon, index) => {
                    evolutionChainDisplay.appendChild(createMatchupPokemonElement(pokemon));
                    if (index < pokemonDataArray.length - 1) {
                        const arrow = document.createElement('span');
                        arrow.className = 'text-2xl text-[var(--color-text-secondary)]';
                        arrow.textContent = '→';
                        evolutionChainDisplay.appendChild(arrow);
                    }
                });

            } catch (error) {
                console.error(error);
                evolutionChainDisplay.innerHTML = `<p class="text-red-500">Could not load evolution line.</p>`;
            }
        };

        const parseEvolutionChain = (chain) => {
            const line = [];
            let current = chain;
            while (current) {
                line.push(current.species.name);
                current = current.evolves_to[0];
            }
            return line;
        };

        const closeEvolutionModal = () => {
            allDOMElements.evolutionModal.classList.add('hidden');
        };


        // Event Listeners
        allDOMElements.pokemonSearchInput.addEventListener('input', handleSearchInput);
        allDOMElements.searchResults.addEventListener('click', handleResultClick);
        allDOMElements.randomBtn.addEventListener('click', selectRandomPokemon);
        allDOMElements.regenerateMatchupsBtn.addEventListener('click', findAndDisplayMatchups);
        allDOMElements.generateBuildBtn.addEventListener('click', generateAiBuild);
        allDOMElements.shinyToggleBtn.addEventListener('click', () => {
            isShiny = !isShiny;
            updateShinyDisplay();
        });
        allDOMElements.manualAnyAbilityCheckbox.addEventListener('change', populateAbilityDropdown);
        allDOMElements.manualAnyMoveCheckbox.addEventListener('change', populateMoveDropdowns);
        allDOMElements.copyManualBuildBtn.addEventListener('click', (e) => {
            const text = generateManualBuildText();
            copyToClipboard(text, e.target);
        });
        allDOMElements.formSelector.addEventListener('change', (e) => {
            fetchPokemon(e.target.value);
        });
        
        allDOMElements.aiBuildDisplay.addEventListener('click', (e) => {
            if (e.target.classList.contains('copy-build-btn')) {
                const buildCard = e.target.closest('.build-card');
                if (buildCard) {
                    let buildText = buildCard.querySelector('pre').textContent;
                    if (isShiny) {
                        const lines = buildText.split('\n');
                        const abilityIndex = lines.findIndex(line => line.trim().startsWith('Ability:'));
                        if (abilityIndex !== -1) {
                            lines.splice(abilityIndex + 1, 0, 'Shiny: Yes');
                            buildText = lines.join('\n');
                        } else {
                            buildText += '\nShiny: Yes';
                        }
                    }
                    copyToClipboard(buildText, e.target);
                }
            }
        });

        allDOMElements.manualPanel.addEventListener('input', (e) => {
            if (e.target.classList.contains('ev-input') || e.target.classList.contains('ev-slider')) {
                if(e.target.classList.contains('ev-slider')) {
                    const stat = e.target.dataset.stat;
                    document.getElementById(`ev-${stat}`).value = e.target.value;
                }
                handleEvChange();
            } else if (e.target.matches('#levelInput, #natureSelector, .iv-input')) {
                calculateAllStats();
            }
        });

        document.addEventListener('click', (e) => {
            if (!allDOMElements.pokemonSearchInput.contains(e.target)) {
                allDOMElements.searchResults.classList.add('hidden');
            }
             if (!allDOMElements.teamBuilderSearchInput.contains(e.target)) {
                allDOMElements.teamBuilderSearchResults.classList.add('hidden');
            }
        });

        // Moves/Abilities Tab Listeners
        allDOMElements.movesTabAnyAbilityCheckbox.addEventListener('change', () => {
            populateMovesTabAbilities();
            displayAbilityDescription(allDOMElements.movesTabAbilitySelector.value);
        });
        allDOMElements.movesTabAbilitySelector.addEventListener('change', (e) => displayAbilityDescription(e.target.value));
        allDOMElements.movesTabItemSelector.addEventListener('change', (e) => displayItemDescription(e.target.value));
        allDOMElements.movesTabNatureSelector.addEventListener('change', (e) => displayNatureDescription(e.target.value));
        allDOMElements.movesTabMovesList.addEventListener('click', (e) => {
            if (e.target.matches('button[data-move-name]')) {
                // Deselect others
                allDOMElements.movesTabMovesList.querySelectorAll('button').forEach(btn => btn.classList.remove('bg-[var(--color-accent)]', 'text-white'));
                // Select clicked
                e.target.classList.add('bg-[var(--color-accent)]', 'text-white');
                displayMoveDescription(e.target.dataset.moveName);
            }
        });
        allDOMElements.movesTabAnyMoveCheckbox.addEventListener('change', populateMovesTabMovesList);
        
        // Team Generator Listener
        allDOMElements.generateTeamBtn.addEventListener('click', generateTeam);

        // Team Filler Listener
        allDOMElements.fillTeamBtn.addEventListener('click', fillTeam);

        // Team Builder Listeners
        allDOMElements.teamBuilderSearchInput.addEventListener('input', handleTeamBuilderSearch);
        allDOMElements.teamBuilderSearchResults.addEventListener('click', (e) => {
             if (e.target.matches('[data-name]')) {
                const pokemon = { name: e.target.dataset.name, id: e.target.dataset.id };
                addPokemonToSelection(pokemon);
                allDOMElements.teamBuilderSearchInput.value = '';
                allDOMElements.teamBuilderSearchResults.classList.add('hidden');
            }
        });
        allDOMElements.selectionPool.addEventListener('click', (e) => {
            if (e.target.matches('button[data-id]')) {
                removePokemonFromSelection(e.target.dataset.id);
            }
        });
        allDOMElements.allocateTeamsBtn.addEventListener('click', allocateTeams);

        // Stat Calculator Listener
        allDOMElements.statCalculatorPanel.addEventListener('input', (e) => {
            if (e.target.classList.contains('calc-ev-input') || e.target.classList.contains('calc-ev-slider')) {
                if(e.target.classList.contains('calc-ev-slider')) {
                    const stat = e.target.dataset.stat;
                    document.getElementById(`calc-ev-${stat}`).value = e.target.value;
                }
                handleCalcEvChange();
            } else {
                calculateCustomStats();
            }
        });

        allDOMElements.sendToCalculatorBtn.addEventListener('click', sendStatsToCalculator);
        allDOMElements.showEvolutionBtn.addEventListener('click', handleShowEvolution);
        allDOMElements.closeEvolutionModalBtn.addEventListener('click', closeEvolutionModal);
        allDOMElements.evolutionModal.addEventListener('click', (e) => {
            if (e.target === allDOMElements.evolutionModal) {
                closeEvolutionModal();
            }
        });


        // Initialize
        window.addEventListener('load', () => {
            themeManager.init();
            populatePokemonList();
            setupManualBuilder();
            setupStatCalculator();
        });
    </script>
</body>
</html>
